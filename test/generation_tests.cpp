#include "testutils.h"
#include "gmock/gmock.h"
#include "gtest/gtest.h"
#include <cstddef>
#include <cstdlib>
#include <fcntl.h>
#include <filesystem>
#include <iostream>
#include <stdint.h>
#include <stdio.h>
#include <string>
#include <sys/mman.h>
#include <unistd.h>
#ifdef __APPLE__
#include <fcntl.h>
#endif // __APPLE__

extern "C"
{
#include "palm/str.h"
#include "test_interface.h"
#include "to_string.h"
}

class GenerationTest : public testing::Test
{
  public:
    char *root_string = nullptr;
    char *symbols_string = nullptr;
    node_st *root = nullptr;
    std::string input_filepath;
    std::string err_output;
    std::string std_output;
    const uint32_t output_buffer_size = 16 * 1024 * 1024;
    // We do not want to put large memory allocation on the stack, also we want to use the benefits
    // of ASan.
    char *output_buffer = nullptr;

  protected:
    GenerationTest()
    {
        output_buffer = new char[output_buffer_size];
        output_buffer[0] = '\0';
    }

    void SetUp(node_st *node)
    {
        testing::internal::CaptureStdout();
        testing::internal::CaptureStderr();
        root = run_code_generation_node(node, output_buffer, output_buffer_size);
        EXPECT_NE(nullptr, root) << "Could not parse ast in file: '" << input_filepath << "'";
        err_output = testing::internal::GetCapturedStderr();
        std_output = testing::internal::GetCapturedStdout();
        ASSERT_THAT(err_output,
                    testing::Not(testing::HasSubstr("error: Inconsistent node found in AST")));
        root_string = node_to_string(root);
        symbols_string = symbols_to_string(root);
        CheckAssembly();
    }

    void SetUpNoExecute(std::string filepath)
    {
        input_filepath =
            std::filesystem::absolute(std::string(PROJECT_DIRECTORY) + "/test/data/" + filepath);
        ASSERT_TRUE(std::filesystem::exists(input_filepath))
            << "File does not exist at path '" << input_filepath << "'";
    }

    void SetUp(std::string filepath)
    {
        SetUpNoExecute(filepath);
        testing::internal::CaptureStdout();
        testing::internal::CaptureStderr();
        root =
            run_code_generation(input_filepath.c_str(), output_buffer, output_buffer_size, false);
        EXPECT_NE(nullptr, root) << "Could not parse ast in file: '" << input_filepath << "'";
        err_output = testing::internal::GetCapturedStderr();
        std_output = testing::internal::GetCapturedStdout();
        ASSERT_THAT(err_output,
                    testing::Not(testing::HasSubstr("error: Inconsistent node found in AST")));
        root_string = node_to_string(root);
        symbols_string = symbols_to_string(root);
        // CheckAssembly();
    }

    void CheckAssembly()
    {
#ifdef PROGRAM_CIVAS
#ifdef __APPLE__
        const testing::TestInfo *const test_info =
            testing::UnitTest::GetInstance()->current_test_info();
        const char *testname = test_info->name();
        int proc_code = open(testname, O_RDWR);
        unlink(testname); // Immediatly remove it from the file sytem
#else                     // Linux
        int proc_code = memfd_create("test_civ_code", 0);
#endif
        ASSERT_NE(-1, proc_code);
        size_t len = STRlen(output_buffer) + 1; // Include null terminate character
        ssize_t written = pwrite(proc_code, output_buffer, len, 0);
        ASSERT_NE(-1, written);

        char *assembler_cmd =
            STRfmt("%s 2>&1 -o /dev/null /proc/self/fd/%d", PROGRAM_CIVAS, proc_code);
        FILE *fd_civas = popen(assembler_cmd, "r");
        free(assembler_cmd);
        ASSERT_NE(nullptr, fd_civas) << "Failed to popen civas";

        const size_t buf_len = 1024;
        char buf[buf_len];

        while (fgets(buf, buf_len, fd_civas) != NULL)
        {
            ASSERT_THAT(std::string(buf), testing::Not(testing::HasSubstr("error")));
        }

        // Close
        int status = pclose(fd_civas);

        ASSERT_NE(-1, status) << "Failed to retrieve the status";
        int exit_status = WEXITSTATUS(status);
        ASSERT_EQ(0, exit_status) << "Error on assembling the generated code.";

        int signal = WIFSIGNALED(status);
        ASSERT_EQ(0, signal) << "Killed by signal: '" << WTERMSIG(status) << "'";
#endif // PROGRAM_CIVAS
    }

    void TearDown() override
    {
        if (root_string != nullptr)
        {

            if (HasFailure())
            {
                std::cerr
                    << "========================================================================\n"
                    << "                        Node Representation\n"
                    << "========================================================================\n"
                    << root_string << std::endl;
            }

            free(root_string);
        }

        if (symbols_string != nullptr)
        {
            if (HasFailure())
            {
                std::cerr
                    << "========================================================================\n"
                    << "                        Symbol Tables of AST\n"
                    << "========================================================================\n"
                    << symbols_string << std::endl;
            }

            free(symbols_string);
        }

        if (root != nullptr)
        {
            cleanup_nodes(root);
            root = nullptr;
        }

        if (output_buffer != nullptr)
        {
            if (HasFailure())
            {
                std::cerr
                    << "========================================================================\n"
                    << "                            Generated Code\n"
                    << "========================================================================\n"
                    << output_buffer << std::endl;
            }
            delete[] output_buffer;
        }
    }
};

TEST_F(GenerationTest, ForLoopsGeneration)
{
    SetUp("codegen/for_loops/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".exportfun \"main\" int main\n"
                           "main:\n"
                           "    esr 8\n"
                           "    iloadc_0\n"
                           "    istore 3\n"
                           "_for0:\n"
                           "    iload_3\n"
                           ".const int 0x64  ; 100\n"
                           "    iloadc 0\n"
                           "    ilt\n"
                           "    branch_f _endfor0\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 1\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    istore 7\n"
                           "    iloadc_0\n"
                           "    istore 4\n"
                           "_for1:\n"
                           "    iload 4\n"
                           "    iload 7\n"
                           "    ilt\n"
                           "    branch_f _endfor1\n"
                           ".const int 0x3  ; 3\n"
                           "    iloadc 2\n"
                           "    istore 1\n"
                           "    iinc_1 4\n"
                           "    jump _for1\n"
                           "_endfor1:\n"
                           "    iinc_1 3\n"
                           "    jump _for0\n"
                           "_endfor0:\n"
                           "    iloadc_0\n"
                           "    istore 5\n"
                           "_for2:\n"
                           "    iload 5\n"
                           ".const int 0xc  ; 12\n"
                           "    iloadc 3\n"
                           "    ilt\n"
                           "    branch_f _endfor2\n"
                           "    iloadc_0\n"
                           "    istore 6\n"
                           "_for3:\n"
                           "    iload 6\n"
                           "    iloadc 0\n"
                           "    ilt\n"
                           "    branch_f _endfor3\n"
                           "    iloadc 2\n"
                           "    istore 2\n"
                           ".const int 0x32  ; 50\n"
                           "    iinc 6 4\n"
                           "    jump _for3\n"
                           "_endfor3:\n"
                           "    iinc 5 1\n"
                           "    jump _for2\n"
                           "_endfor2:\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, WhileLoopsGeneration)
{
    SetUp("codegen/while_loops/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".exportfun \"main\" int main\n"
                           "main:\n"
                           "    esr 3\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           "    iloadc_1\n"
                           "    istore 1\n"
                           "_while0:\n"
                           "    iload_0\n"
                           ".const int 0x64  ; 100\n"
                           "    iloadc 1\n"
                           "    ilt\n"
                           "    branch_f _whileend0\n"
                           "    iinc_1 0\n"
                           "    jump _while0\n"
                           "_whileend0:\n"
                           "    iloadc_1\n"
                           "    istore 0\n"
                           "_while1:\n"
                           "    iload_0\n"
                           ".const int 0x16  ; 22\n"
                           "    iloadc 2\n"
                           "    ilt\n"
                           "    branch_f _whileend1\n"
                           "    iloadc_0\n"
                           "    istore 2\n"
                           "_for2:\n"
                           "    iload_2\n"
                           "    iloadc 1\n"
                           "    ilt\n"
                           "    branch_f _endfor2\n"
                           ".const int 0x3  ; 3\n"
                           "    iinc 1 3\n"
                           ".const int 0x32  ; 50\n"
                           "    iinc 2 4\n"
                           "    jump _for2\n"
                           "_endfor2:\n"
                           "    iinc_1 0\n"
                           "    jump _while1\n"
                           "_whileend1:\n"
                           "    iload_1\n"
                           "    istore 0\n"
                           "_while3:\n"
                           "    iload_0\n"
                           ".const int 0x22  ; 34\n"
                           "    iloadc 5\n"
                           "    igt\n"
                           "    branch_f _whileend3\n"
                           "    idec_1 0\n"
                           "    jump _while3\n"
                           "_whileend3:\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, DoWhileLoopsGeneration)
{
    SetUp("codegen/do_while_loops/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".exportfun \"main\" int main\n"
                           "main:\n"
                           "    esr 3\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           "    iloadc_0\n"
                           "    istore 1\n"
                           "_while0:\n"
                           ".const int 0x2  ; 2\n"
                           "    iinc 1 1\n"
                           "    iinc_1 0\n"
                           "    iload_0\n"
                           ".const int 0x64  ; 100\n"
                           "    iloadc 2\n"
                           "    ilt\n"
                           "    branch_t _while0\n"
                           "    iloadc_1\n"
                           "    istore 0\n"
                           "_while1:\n"
                           "    iloadc_0\n"
                           "    istore 2\n"
                           "_for2:\n"
                           "    iload_2\n"
                           "    iloadc 2\n"
                           "    ilt\n"
                           "    branch_f _endfor2\n"
                           ".const int 0x3  ; 3\n"
                           "    iinc 1 3\n"
                           ".const int 0x32  ; 50\n"
                           "    iinc 2 4\n"
                           "    jump _for2\n"
                           "_endfor2:\n"
                           "    iinc_1 0\n"
                           "    iload_0\n"
                           ".const int 0x16  ; 22\n"
                           "    iloadc 5\n"
                           "    ilt\n"
                           "    branch_t _while1\n"
                           "    iload_1\n"
                           "    istore 0\n"
                           "_while3:\n"
                           "    idec_1 0\n"
                           "    iload_0\n"
                           ".const int 0x22  ; 34\n"
                           "    iloadc 6\n"
                           "    igt\n"
                           "    branch_t _while3\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, BinopsGeneration)
{
    SetUp("codegen/binops/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".exportfun \"main\" int main\n"
                           "main:\n"
                           "    esr 5\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           ".const float 0x1p-1  ; 5.000000e-01\n"
                           "    floadc 1\n"
                           "    fstore 1\n"
                           "    bloadc_t\n"
                           "    bstore 2\n"
                           "    fload_1\n"
                           ".const float 0x1.8p+2  ; 6.000000e+00\n"
                           "    floadc 2\n"
                           "    flt\n"
                           "    branch_f _pfalse1\n"
                           "    fload_1\n"
                           "    floadc 2\n"
                           "    fle\n"
                           "    jump _pend1\n"
                           "_pfalse1:\n"
                           "    bloadc_f\n"
                           "_pend1:\n"
                           "    branch_f _ifend0\n"
                           "    bloadc_f\n"
                           "    bstore 2\n"
                           "_ifend0:\n"
                           "    bload_2\n"
                           "    branch_f _ifend2\n"
                           ".const int 0xa  ; 10\n"
                           "    iloadc 3\n"
                           "    istore 0\n"
                           "_ifend2:\n"
                           "    iload_0\n"
                           ".const int 0x6  ; 6\n"
                           "    iloadc 4\n"
                           "    igt\n"
                           "    branch_f _pfalse4\n"
                           "    bloadc_t\n"
                           "    jump _pend4\n"
                           "_pfalse4:\n"
                           "    iload_0\n"
                           "    iloadc_0\n"
                           "    ilt\n"
                           "_pend4:\n"
                           "    branch_f _ifend3\n"
                           "    floadc_1\n"
                           "    fstore 1\n"
                           "_ifend3:\n"
                           "    iload_0\n"
                           "    iloadc 0\n"
                           "    imul\n"
                           "    istore 3\n"
                           "    fload_1\n"
                           ".const float 0x1p+1  ; 2.000000e+00\n"
                           "    floadc 5\n"
                           "    fdiv\n"
                           "    fstore 1\n"
                           "    iload_3\n"
                           ".const int 0x7  ; 7\n"
                           "    iloadc 6\n"
                           "    irem\n"
                           "    istore 4\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, MonopsGeneration)
{
    SetUp("codegen/monops/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".exportfun \"main\" int main\n"
                           "main:\n"
                           "    esr 5\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           "    bloadc_t\n"
                           "    bstore 2\n"
                           ".const float 0x1.8p+0  ; 1.500000e+00\n"
                           "    floadc 1\n"
                           "    fstore 1\n"
                           "    bload_2\n"
                           "    bnot\n"
                           "    branch_f _ifend0\n"
                           ".const float 0x1.4p+1  ; 2.500000e+00\n"
                           "    floadc 2\n"
                           "    fstore 1\n"
                           "_ifend0:\n"
                           "    fload_1\n"
                           "    fneg\n"
                           "    floadc_1\n"
                           "    fmul\n"
                           "    fstore 3\n"
                           "    iload_0\n"
                           "    ineg\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 3\n"
                           "    isub\n"
                           "    istore 4\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, CastsGeneration)
{
    SetUp("codegen/casts/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".exportfun \"main\" int main\n"
                           "main:\n"
                           "    esr 4\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           ".const float 0x1.999999999999ap+0  ; 1.600000e+00\n"
                           "    floadc 1\n"
                           "    fstore 3\n"
                           "    iload_0\n"
                           "    i2f\n"
                           "    fstore 1\n"
                           "    fload_3\n"
                           "    f2i\n"
                           "    istore 2\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, ArrayInitGeneration)
{
    SetUp("codegen/array_init/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".exportfun \"main\" int main\n"
                           "main:\n"
                           "    esr 6\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    inewa\n"
                           "    astore 1\n"
                           "    iloadc_1\n"
                           "    iloadc_0\n"
                           "    aload_1\n"
                           "    istorea\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 1\n"
                           "    iloadc_1\n"
                           "    aload_1\n"
                           "    istorea\n"
                           ".const int 0x3  ; 3\n"
                           "    iloadc 2\n"
                           "    iloadc 1\n"
                           "    aload_1\n"
                           "    istorea\n"
                           ".const int 0x4  ; 4\n"
                           "    iloadc 3\n"
                           "    iloadc 2\n"
                           "    aload_1\n"
                           "    istorea\n"
                           "    iloadc 0\n"
                           "    iloadc 3\n"
                           "    aload_1\n"
                           "    istorea\n"
                           "    iloadc 1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    istore 2\n"
                           "    iload_2\n"
                           "    fnewa\n"
                           "    astore 3\n"
                           "    floadc_1\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aload_3\n"
                           "    fstorea\n"
                           ".const float 0x1p+1  ; 2.000000e+00\n"
                           "    floadc 4\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload_3\n"
                           "    fstorea\n"
                           ".const float 0x1.8p+1  ; 3.000000e+00\n"
                           "    floadc 5\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    aload_3\n"
                           "    fstorea\n"
                           ".const float 0x1p+2  ; 4.000000e+00\n"
                           "    floadc 6\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aload_3\n"
                           "    fstorea\n"
                           ".const float 0x1.4p+2  ; 5.000000e+00\n"
                           "    floadc 7\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload_3\n"
                           "    fstorea\n"
                           ".const float 0x1.8p+2  ; 6.000000e+00\n"
                           "    floadc 8\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    aload_3\n"
                           "    fstorea\n"
                           "    iloadc 1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    istore 4\n"
                           "    iload 4\n"
                           "    bnewa\n"
                           "    astore 5\n"
                           "    bloadc_t\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aload 5\n"
                           "    bstorea\n"
                           "    bloadc_f\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload 5\n"
                           "    bstorea\n"
                           "    bloadc_f\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aload 5\n"
                           "    bstorea\n"
                           "    bloadc_f\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload 5\n"
                           "    bstorea\n"
                           "    bloadc_t\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aload 5\n"
                           "    bstorea\n"
                           "    bloadc_t\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload 5\n"
                           "    bstorea\n"
                           "    bloadc_f\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aload 5\n"
                           "    bstorea\n"
                           "    bloadc_t\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload 5\n"
                           "    bstorea\n"
                           "    bloadc_t\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aload 5\n"
                           "    bstorea\n"
                           "    bloadc_t\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload 5\n"
                           "    bstorea\n"
                           "    bloadc_f\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aload 5\n"
                           "    bstorea\n"
                           "    bloadc_f\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload 5\n"
                           "    bstorea\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, ExternGeneration)
{
    SetUp("codegen/extern/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".importvar \"a\" int\n"
                           ".importvar \"b\" float\n"
                           ".importvar \"c\" bool\n"
                           ".global int\n"
                           ".importvar \"__dim0_arr1\" int\n"
                           ".importvar \"arr1\" int[]\n"
                           ".importvar \"__dim0_arr2\" int\n"
                           ".importvar \"__dim1_arr2\" int\n"
                           ".importvar \"arr2\" float[]\n"
                           ".importvar \"__dim0_arr3\" int\n"
                           ".importvar \"__dim1_arr3\" int\n"
                           ".importvar \"__dim2_arr3\" int\n"
                           ".importvar \"arr3\" bool[]\n"
                           ".importfun \"fun1\" void\n"
                           ".importfun \"fun2\" int\n"
                           ".importfun \"fun3\" float\n"
                           ".importfun \"fun4\" bool\n"
                           ".exportfun \"main\" int main\n"
                           "main:\n"
                           "    esr 3\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 0\n"
                           "    istoree 0\n"
                           "    iloadc_0\n"
                           "    aloade 4\n"
                           "    iloada\n"
                           "    iloade 0\n"
                           "    iadd\n"
                           "    istore 0\n"
                           "    isrg\n"
                           "    jsre 1\n"
                           "    iload_0\n"
                           "    iadd\n"
                           "    istore 1\n"
                           "    iload_1\n"
                           "    iloadg 0\n"
                           "    iadd\n"
                           "    istore 2\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           ".const int 0x6  ; 6\n"
                           "    iloadc 1\n"
                           "    istoreg 0\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, GlobalArrayAssignmentsGeneration)
{
    SetUp("milestone_6/array_init/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".global int[]\n"
                           ".global int[]\n"
                           ".global int\n"
                           ".global int[]\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    esr 3\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    inewa\n"
                           "    astoreg 0\n"
                           "    iloadc_1\n"
                           "    iloadc_0\n"
                           "    aloadg 0\n"
                           "    istorea\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 1\n"
                           "    iloadc_1\n"
                           "    aloadg 0\n"
                           "    istorea\n"
                           ".const int 0x3  ; 3\n"
                           "    iloadc 2\n"
                           "    iloadc 1\n"
                           "    aloadg 0\n"
                           "    istorea\n"
                           ".const int 0x4  ; 4\n"
                           "    iloadc 3\n"
                           "    iloadc 2\n"
                           "    aloadg 0\n"
                           "    istorea\n"
                           "    iloadc 0\n"
                           "    iloadc 3\n"
                           "    aloadg 0\n"
                           "    istorea\n"
                           "    iloadc 1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    istore 1\n"
                           "    iload_1\n"
                           "    inewa\n"
                           "    astoreg 1\n"
                           "    iloadc_1\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aloadg 1\n"
                           "    istorea\n"
                           "    iloadc 1\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aloadg 1\n"
                           "    istorea\n"
                           "    iloadc 2\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    aloadg 1\n"
                           "    istorea\n"
                           "    iloadc 3\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aloadg 1\n"
                           "    istorea\n"
                           "    iloadc 0\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aloadg 1\n"
                           "    istorea\n"
                           ".const int 0x6  ; 6\n"
                           "    iloadc 4\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    aloadg 1\n"
                           "    istorea\n"
                           "    iloadc 0\n"
                           "    istoreg 2\n"
                           "    iloadc 1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    istore 2\n"
                           "    iload_2\n"
                           "    inewa\n"
                           "    astoreg 3\n"
                           "    iloadg 2\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           "    iloadc 1\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           "    iloadc 2\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           "    iloadc 3\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc 2\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           "    iloadc 0\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           "    iloadc 4\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0x7  ; 7\n"
                           "    iloadc 5\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0x8  ; 8\n"
                           "    iloadc 6\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc 2\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0x9  ; 9\n"
                           "    iloadc 7\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0xa  ; 10\n"
                           "    iloadc 8\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0xb  ; 11\n"
                           "    iloadc 9\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0xc  ; 12\n"
                           "    iloadc 10\n"
                           "    iloadc_0\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc 2\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0xd  ; 13\n"
                           "    iloadc 11\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0xe  ; 14\n"
                           "    iloadc 12\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0xf  ; 15\n"
                           "    iloadc 13\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0x10  ; 16\n"
                           "    iloadc 14\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc 2\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0x11  ; 17\n"
                           "    iloadc 15\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0x12  ; 18\n"
                           "    iloadc 16\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0x13  ; 19\n"
                           "    iloadc 17\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0x14  ; 20\n"
                           "    iloadc 18\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc 2\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0x15  ; 21\n"
                           "    iloadc 19\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0x16  ; 22\n"
                           "    iloadc 20\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0x17  ; 23\n"
                           "    iloadc 21\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           ".const int 0x18  ; 24\n"
                           "    iloadc 22\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    iloadc 3\n"
                           "    imul\n"
                           "    iloadc 2\n"
                           "    iadd\n"
                           "    aloadg 3\n"
                           "    istorea\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, InitFunGeneration)
{
    SetUp("milestone_6/init_fun/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".global int\n"
                           ".global int\n"
                           ".global float\n"
                           ".global float\n"
                           ".global bool\n"
                           ".global bool\n"
                           ".global int[]\n"
                           ".global int[]\n"
                           ".global float[]\n"
                           ".global float[]\n"
                           ".global bool[]\n"
                           ".global bool[]\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    esr 12\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 0\n"
                           "    istoreg 0\n"
                           ".const float 0x1.8p+1  ; 3.000000e+00\n"
                           "    floadc 1\n"
                           "    fstoreg 2\n"
                           "    bloadc_t\n"
                           "    bstoreg 4\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    inewa\n"
                           "    astoreg 6\n"
                           ".const int 0x4  ; 4\n"
                           "    iloadc 2\n"
                           "    istore 1\n"
                           "    iloadc_0\n"
                           "    istore 2\n"
                           "_for0:\n"
                           "    iload_2\n"
                           "    iload_0\n"
                           "    ilt\n"
                           "    branch_f _endfor0\n"
                           "    iload_1\n"
                           "    iload_2\n"
                           "    aloadg 6\n"
                           "    istorea\n"
                           "    iinc_1 2\n"
                           "    jump _for0\n"
                           "_endfor0:\n"
                           ".const int 0x3  ; 3\n"
                           "    iloadc 3\n"
                           "    istore 3\n"
                           "    iload_3\n"
                           "    inewa\n"
                           "    astoreg 7\n"
                           "    iloadc 2\n"
                           "    istore 4\n"
                           "    iload 4\n"
                           "    fnewa\n"
                           "    astoreg 8\n"
                           ".const float 0x1.4p+2  ; 5.000000e+00\n"
                           "    floadc 4\n"
                           "    fstore 5\n"
                           "    iloadc_0\n"
                           "    istore 6\n"
                           "_for1:\n"
                           "    iload 6\n"
                           "    iload 4\n"
                           "    ilt\n"
                           "    branch_f _endfor1\n"
                           "    fload 5\n"
                           "    iload 6\n"
                           "    aloadg 8\n"
                           "    fstorea\n"
                           "    iinc_1 6\n"
                           "    jump _for1\n"
                           "_endfor1:\n"
                           ".const int 0x6  ; 6\n"
                           "    iloadc 5\n"
                           "    istore 7\n"
                           "    iload 7\n"
                           "    fnewa\n"
                           "    astoreg 9\n"
                           ".const int 0x7  ; 7\n"
                           "    iloadc 6\n"
                           "    istore 8\n"
                           "    iload 8\n"
                           "    bnewa\n"
                           "    astoreg 10\n"
                           "    bloadc_t\n"
                           "    bstore 9\n"
                           "    iloadc_0\n"
                           "    istore 10\n"
                           "_for2:\n"
                           "    iload 10\n"
                           "    iload 8\n"
                           "    ilt\n"
                           "    branch_f _endfor2\n"
                           "    bload 9\n"
                           "    iload 10\n"
                           "    aloadg 10\n"
                           "    bstorea\n"
                           "    iinc_1 10\n"
                           "    jump _for2\n"
                           "_endfor2:\n"
                           ".const int 0x9  ; 9\n"
                           "    iloadc 7\n"
                           "    istore 11\n"
                           "    iload 11\n"
                           "    bnewa\n"
                           "    astoreg 11\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, ArrayFunGeneration)
{
    SetUp("milestone_6/array_fun/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".global int\n"
                           "fun:\n"
                           "    esr 9\n"
                           ".const int 0x4  ; 4\n"
                           "    iloadc 0\n"
                           "    istore 2\n"
                           "    iload_2\n"
                           "    inewa\n"
                           "    astore 5\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 1\n"
                           "    istore 3\n"
                           "    iloadc_0\n"
                           "    istore 4\n"
                           "_for0:\n"
                           "    iload 4\n"
                           "    iload_2\n"
                           "    ilt\n"
                           "    branch_f _endfor0\n"
                           "    iload_3\n"
                           "    iload 4\n"
                           "    aload 5\n"
                           "    istorea\n"
                           "    iinc_1 4\n"
                           "    jump _for0\n"
                           "_endfor0:\n"
                           "    iloadc_1\n"
                           "    aload 5\n"
                           "    iloada\n"
                           "    istore 6\n"
                           ".const int 0x6  ; 6\n"
                           "    iloadc 2\n"
                           "    istore 7\n"
                           "    iload 6\n"
                           "    iload 7\n"
                           "    iadd\n"
                           "    istore 8\n"
                           "    iload 8\n"
                           "    iload 7\n"
                           "    imul\n"
                           "    istore 9\n"
                           "    iload 9\n"
                           "    inewa\n"
                           "    astore 10\n"
                           "    return\n"
                           "fukk:\n"
                           "    esr 4\n"
                           ".const int 0x3  ; 3\n"
                           "    iloadc 3\n"
                           "    iloadc 3\n"
                           "    iadd\n"
                           "    istore 2\n"
                           "    iloadc 1\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    istore 3\n"
                           "    iload_2\n"
                           "    iload_3\n"
                           "    imul\n"
                           "    istore 4\n"
                           "    iload 4\n"
                           "    inewa\n"
                           "    astore 5\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           ".const int 0x7  ; 7\n"
                           "    iloadc 4\n"
                           "    istoreg 0\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, ArrayParamsGeneration)
{
    SetUp("milestone_8/arr_params/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "fun:\n"
                           "    esr 1\n"
                           "    iloadc_1\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 0\n"
                           "    iadd\n"
                           "    istore 3\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, ArrayProccallGeneration)
{
    SetUp("milestone_8/arr_proccall/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "fun_one:\n"
                           "    isrg\n"
                           "    iload_0\n"
                           "    iload_1\n"
                           "    aload_2\n"
                           "    jsr 3 fun_two\n"
                           "    return\n"
                           "fun_two:\n"
                           "    esr 1\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 0\n"
                           "    istore 3\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, ArrTwoArrParamsGeneration)
{
    SetUp("milestone_8/two_arr_params/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "fun:\n"
                           "    esr 1\n"
                           "    iloadc_1\n"
                           "    istore 6\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, ArrTwoProccallGeneration)
{
    SetUp("milestone_8/two_arr_proccall/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "fun_one:\n"
                           "    esr 1\n"
                           "    iloadc_1\n"
                           "    istore 6\n"
                           "    return\n"
                           "fun_two:\n"
                           "    isrg\n"
                           "    iload_0\n"
                           "    iload_1\n"
                           "    iload_2\n"
                           "    iload_3\n"
                           "    aload 4\n"
                           "    aload 5\n"
                           "    jsr 6 fun_one\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, ArrDoubleArrProccallGeneration)
{
    SetUp("milestone_8/double_arr_proccall/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "fun:\n"
                           "    isrg\n"
                           "    iload_2\n"
                           "    iload_3\n"
                           "    iload_2\n"
                           "    iload_3\n"
                           "    aload 4\n"
                           "    aload 4\n"
                           "    jsr 6 fun2\n"
                           "    return\n"
                           "fun2:\n"
                           "    esr 1\n"
                           "    iloadc_1\n"
                           "    istore 6\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, ShortCircuitGeneration)
{
    SetUp("milestone_9/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".global bool\n"
                           ".global bool\n"
                           ".global bool\n"
                           ".global bool\n"
                           "test:\n"
                           "    esr 2\n"
                           "    bloadc_f\n"
                           "    bstore 0\n"
                           "    iloadc_1\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 0\n"
                           "    bloadg 3\n"
                           "    branch_f _pfalse1\n"
                           "    bloadc_t\n"
                           "    jump _pend1\n"
                           "_pfalse1:\n"
                           "    bload_0\n"
                           "    bload_0\n"
                           "    bloadg 3\n"
                           "    bmul\n"
                           "    badd\n"
                           "_pend1:\n"
                           "    branch_f _pfalse0\n"
                           "    iloadc_1\n"
                           "    jump _pend0\n"
                           "_pfalse0:\n"
                           "    iloadc_0\n"
                           "_pend0:\n"
                           "    imul\n"
                           "    iadd\n"
                           "    istore 1\n"
                           "    bloadg 3\n"
                           "    branch_f _pfalse3\n"
                           "    bload_0\n"
                           "    branch_f _pfalse4\n"
                           "    bloadc_t\n"
                           "    jump _pend4\n"
                           "_pfalse4:\n"
                           "    bloadg 3\n"
                           "    bnot\n"
                           "_pend4:\n"
                           "    jump _pend3\n"
                           "_pfalse3:\n"
                           "    bloadc_f\n"
                           "_pend3:\n"
                           "    branch_f _ifend2\n"
                           "    return\n"
                           "_ifend2:\n"
                           "_while0:\n"
                           "    bloadg 3\n"
                           "    branch_f _pfalse10\n"
                           "    bloadg 3\n"
                           "    jump _pend10\n"
                           "_pfalse10:\n"
                           "    bloadc_f\n"
                           "_pend10:\n"
                           "    branch_f _pfalse9\n"
                           "    bloadg 3\n"
                           "    jump _pend9\n"
                           "_pfalse9:\n"
                           "    bloadc_f\n"
                           "_pend9:\n"
                           "    branch_f _pfalse8\n"
                           "    bloadg 3\n"
                           "    jump _pend8\n"
                           "_pfalse8:\n"
                           "    bloadc_f\n"
                           "_pend8:\n"
                           "    branch_f _pfalse7\n"
                           "    bloadc_t\n"
                           "    jump _pend7\n"
                           "_pfalse7:\n"
                           "    bload_0\n"
                           "_pend7:\n"
                           "    branch_f _pfalse6\n"
                           "    bloadc_t\n"
                           "    jump _pend6\n"
                           "_pfalse6:\n"
                           "    bload_0\n"
                           "_pend6:\n"
                           "    branch_f _pfalse5\n"
                           "    bloadc_t\n"
                           "    jump _pend5\n"
                           "_pfalse5:\n"
                           "    bload_0\n"
                           "    branch_f _pfalse11\n"
                           "    bloadg 3\n"
                           "    jump _pend11\n"
                           "_pfalse11:\n"
                           "    bloadc_f\n"
                           "_pend11:\n"
                           "_pend5:\n"
                           "    branch_f _whileend0\n"
                           "    return\n"
                           "    jump _while0\n"
                           "_whileend0:\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    bloadc_t\n"
                           "    bstoreg 0\n"
                           "    bloadc_f\n"
                           "    bstoreg 1\n"
                           "    bloadc_t\n"
                           "    bstoreg 2\n"
                           "    bloadg 0\n"
                           "    branch_f _pfalse13\n"
                           "    bloadg 1\n"
                           "    jump _pend13\n"
                           "_pfalse13:\n"
                           "    bloadc_f\n"
                           "_pend13:\n"
                           "    branch_f _pfalse12\n"
                           "    bloadg 2\n"
                           "    jump _pend12\n"
                           "_pfalse12:\n"
                           "    bloadc_f\n"
                           "_pend12:\n"
                           "    bstoreg 3\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, BooleanTestGeneration)
{
    SetUp("milestone_10/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "test:\n"
                           "    esr 9\n"
                           "    bloadc_f\n"
                           "    branch_f _pfalse0\n"
                           "    iloadc_1\n"
                           "    jump _pend0\n"
                           "_pfalse0:\n"
                           "    iloadc_0\n"
                           "_pend0:\n"
                           "    istore 0\n"
                           "    floadc_0\n"
                           "    f2i\n"
                           "    istore 1\n"
                           "    iloadc_0\n"
                           "    istore 2\n"
                           "    bloadc_t\n"
                           "    branch_f _pfalse1\n"
                           "    floadc_1\n"
                           "    jump _pend1\n"
                           "_pfalse1:\n"
                           "    floadc_0\n"
                           "_pend1:\n"
                           "    fstore 3\n"
                           ".const float 0x1.8p+1  ; 3.000000e+00\n"
                           "    floadc 0\n"
                           "    fstore 4\n"
                           ".const int 0x3  ; 3\n"
                           "    iloadc 1\n"
                           "    i2f\n"
                           "    fstore 5\n"
                           "    bloadc_f\n"
                           "    bstore 6\n"
                           ".const float 0x1.4p+3  ; 1.000000e+01\n"
                           "    floadc 2\n"
                           "    floadc_0\n"
                           "    fne\n"
                           "    branch_f _pfalse2\n"
                           "    bloadc_t\n"
                           "    jump _pend2\n"
                           "_pfalse2:\n"
                           "    bloadc_f\n"
                           "_pend2:\n"
                           "    bstore 7\n"
                           ".const int 0xa  ; 10\n"
                           "    iloadc 3\n"
                           "    iloadc_0\n"
                           "    ine\n"
                           "    branch_f _pfalse3\n"
                           "    bloadc_t\n"
                           "    jump _pend3\n"
                           "_pfalse3:\n"
                           "    bloadc_f\n"
                           "_pend3:\n"
                           "    bstore 8\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, DimensionReductionGeneration)
{
    SetUp("milestone_11/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".global int\n"
                           ".global int\n"
                           ".global int[]\n"
                           ".importvar \"__dim0_b\" int\n"
                           ".importvar \"__dim1_b\" int\n"
                           ".importvar \"b\" int[]\n"
                           "test:\n"
                           "    esr 12\n"
                           "    iload_3\n"
                           "    iload_2\n"
                           "    imul\n"
                           "    iload_1\n"
                           "    imul\n"
                           "    iload_0\n"
                           "    imul\n"
                           "    istore 5\n"
                           "    iload 5\n"
                           "    inewa\n"
                           "    astore 8\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 0\n"
                           "    istore 6\n"
                           "    iloadc_0\n"
                           "    istore 7\n"
                           "_for0:\n"
                           "    iload 7\n"
                           "    iload 5\n"
                           "    ilt\n"
                           "    branch_f _endfor0\n"
                           "    iload 6\n"
                           "    iload 7\n"
                           "    aload 8\n"
                           "    istorea\n"
                           "    iinc_1 7\n"
                           "    jump _for0\n"
                           "_endfor0:\n"
                           "    iload_3\n"
                           "    istore 13\n"
                           "    iloadc_0\n"
                           "    istore 9\n"
                           "_for1:\n"
                           "    iload 9\n"
                           "    iload 13\n"
                           "    ilt\n"
                           "    branch_f _endfor1\n"
                           "    iload_2\n"
                           "    istore 14\n"
                           "    iloadc_0\n"
                           "    istore 10\n"
                           "_for2:\n"
                           "    iload 10\n"
                           "    iload 14\n"
                           "    ilt\n"
                           "    branch_f _endfor2\n"
                           "    iload_1\n"
                           "    istore 15\n"
                           "    iloadc_0\n"
                           "    istore 11\n"
                           "_for3:\n"
                           "    iload 11\n"
                           "    iload 15\n"
                           "    ilt\n"
                           "    branch_f _endfor3\n"
                           "    iload_0\n"
                           "    istore 16\n"
                           "    iloadc_0\n"
                           "    istore 12\n"
                           "_for4:\n"
                           "    iload 12\n"
                           "    iload 16\n"
                           "    ilt\n"
                           "    branch_f _endfor4\n"
                           "    iload 9\n"
                           "    iload_2\n"
                           "    imul\n"
                           "    iload 10\n"
                           "    iadd\n"
                           "    iload_1\n"
                           "    imul\n"
                           "    iload 11\n"
                           "    iadd\n"
                           "    iload_0\n"
                           "    imul\n"
                           "    iload 12\n"
                           "    iadd\n"
                           "    aload 4\n"
                           "    iloada\n"
                           "    iload 11\n"
                           "    iloadg 1\n"
                           "    imul\n"
                           "    iload 12\n"
                           "    iadd\n"
                           "    aloadg 2\n"
                           "    iloada\n"
                           "    iload 11\n"
                           "    iloade 1\n"
                           "    imul\n"
                           "    iload 12\n"
                           "    iadd\n"
                           "    aloade 2\n"
                           "    iloada\n"
                           "    imul\n"
                           "    iadd\n"
                           "    iload 9\n"
                           "    iload_2\n"
                           "    imul\n"
                           "    iload 10\n"
                           "    iadd\n"
                           "    iload_1\n"
                           "    imul\n"
                           "    iload 11\n"
                           "    iadd\n"
                           "    iload_0\n"
                           "    imul\n"
                           "    iload 12\n"
                           "    iadd\n"
                           "    aload 8\n"
                           "    istorea\n"
                           "    iinc_1 12\n"
                           "    jump _for4\n"
                           "_endfor4:\n"
                           "    iinc_1 11\n"
                           "    jump _for3\n"
                           "_endfor3:\n"
                           "    iinc_1 10\n"
                           "    jump _for2\n"
                           "_endfor2:\n"
                           "    iinc_1 9\n"
                           "    jump _for1\n"
                           "_endfor1:\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    esr 1\n"
                           "    iloadg 0\n"
                           "    iloadg 1\n"
                           "    imul\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    inewa\n"
                           "    astoreg 2\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, ManualExample)
{
    SetUp("codegen/manual_example/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".importfun \"printInt\" void int\n"
                           ".importfun \"scanInt\" int\n"
                           ".exportfun \"main\" int main\n"
                           "main:\n"
                           "    esr 3\n"
                           "    isrg\n"
                           "    jsre 1\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    istore 1\n"
                           "    iload_1\n"
                           "    inewa\n"
                           "    astore 2\n"
                           "    isrg\n"
                           "    iload_0\n"
                           "    aload_2\n"
                           "    jsr 2 readValues\n"
                           "    isrg\n"
                           "    iload_0\n"
                           "    aload_2\n"
                           "    jsr 2 printValues\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           "readValues:\n"
                           "    esr 2\n"
                           "    iload_0\n"
                           "    istore 3\n"
                           "    iloadc_0\n"
                           "    istore 2\n"
                           "_for0:\n"
                           "    iload_2\n"
                           "    iload_3\n"
                           "    ilt\n"
                           "    branch_f _endfor0\n"
                           "    isrg\n"
                           "    jsre 1\n"
                           "    iload_2\n"
                           "    aload_1\n"
                           "    istorea\n"
                           "    iinc_1 2\n"
                           "    jump _for0\n"
                           "_endfor0:\n"
                           "    return\n"
                           "printValues:\n"
                           "    esr 2\n"
                           "    iload_0\n"
                           "    istore 3\n"
                           "    iloadc_0\n"
                           "    istore 2\n"
                           "_for1:\n"
                           "    iload_2\n"
                           "    iload_3\n"
                           "    ilt\n"
                           "    branch_f _endfor1\n"
                           "    isrg\n"
                           "    iload_2\n"
                           "    aload_1\n"
                           "    iloada\n"
                           "    jsre 0\n"
                           "    iinc_1 2\n"
                           "    jump _for1\n"
                           "_endfor1:\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Typecheck_Valid)
{
    SetUp("typecheck/valid/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "ops:\n"
                           "    esr 2\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 0\n"
                           ".const int 0x3  ; 3\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           ".const int 0x7  ; 7\n"
                           "    iloadc 2\n"
                           "    igt\n"
                           "    bstore 0\n"
                           "    iloadc 0\n"
                           "    iloadc 0\n"
                           "    ineg\n"
                           "    isub\n"
                           "    istore 1\n"
                           ".const float 0x1.4p+2  ; 5.000000e+00\n"
                           "    floadc 3\n"
                           ".const float 0x1.8p+1  ; 3.000000e+00\n"
                           "    floadc 4\n"
                           "    fadd\n"
                           ".const float 0x1.cp+2  ; 7.000000e+00\n"
                           "    floadc 5\n"
                           "    fne\n"
                           "    bstore 0\n"
                           "    floadc 3\n"
                           "    floadc 4\n"
                           "    fsub\n"
                           "    floadc 5\n"
                           "    feq\n"
                           "    bstore 0\n"
                           "    iloadc 0\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    iloadc 2\n"
                           "    ine\n"
                           "    bstore 0\n"
                           "    iloadc 0\n"
                           "    iloadc 1\n"
                           "    isub\n"
                           "    iloadc 2\n"
                           "    ieq\n"
                           "    bstore 0\n"
                           "    bloadc_t\n"
                           "    bload_0\n"
                           "    bne\n"
                           "    bstore 0\n"
                           "    bloadc_t\n"
                           "    bload_0\n"
                           "    beq\n"
                           "    bstore 0\n"
                           "    floadc 3\n"
                           "    floadc 4\n"
                           "    fmul\n"
                           "    floadc 5\n"
                           "    fneg\n"
                           "    floadc 4\n"
                           "    fdiv\n"
                           "    flt\n"
                           "    bstore 0\n"
                           "    iloadc 0\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    iloadc 2\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 6\n"
                           "    idiv\n"
                           "    ile\n"
                           "    bstore 0\n"
                           "    iloadc 0\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    iloadc 2\n"
                           "    iloadc 6\n"
                           "    imul\n"
                           "    ige\n"
                           "    bstore 0\n"
                           "    bload_0\n"
                           "    bnot\n"
                           "    bstore 0\n"
                           "    iloadc 0\n"
                           "    iloadc 2\n"
                           "    igt\n"
                           "    bnot\n"
                           "    bnot\n"
                           "    bnot\n"
                           "    bnot\n"
                           "    bstore 0\n"
                           "    bload_0\n"
                           "    bload_0\n"
                           "    bload_0\n"
                           "    bmul\n"
                           "    badd\n"
                           "    bstore 0\n"
                           "    iload_1\n"
                           "    iload_1\n"
                           "    irem\n"
                           "    iloadc 0\n"
                           "    ineg\n"
                           "    iadd\n"
                           "    istore 1\n"
                           "    bload_0\n"
                           "    branch_f _pfalse1\n"
                           "    bload_0\n"
                           "    jump _pend1\n"
                           "_pfalse1:\n"
                           "    bloadc_f\n"
                           "_pend1:\n"
                           "    branch_f _pfalse0\n"
                           "    bloadc_t\n"
                           "    jump _pend0\n"
                           "_pfalse0:\n"
                           "    bloadc_f\n"
                           "_pend0:\n"
                           "    bstore 0\n"
                           "    bload_0\n"
                           "    branch_f _pfalse3\n"
                           "    bloadc_t\n"
                           "    jump _pend3\n"
                           "_pfalse3:\n"
                           "    bload_0\n"
                           "_pend3:\n"
                           "    branch_f _pfalse2\n"
                           "    bloadc_t\n"
                           "    jump _pend2\n"
                           "_pfalse2:\n"
                           "    bloadc_f\n"
                           "_pend2:\n"
                           "    bstore 0\n"
                           "    return\n"
                           "retint:\n"
                           "    bloadc_t\n"
                           "    branch_f _ifend4\n"
                           "    iloadc_1\n"
                           "    ireturn\n"
                           "_ifend4:\n"
                           "    iloadc 0\n"
                           "    ireturn\n"
                           "lf0_retfloat:\n"
                           "    bloadc_t\n"
                           "    branch_f _else5\n"
                           ".const float 0x1.8p+2  ; 6.000000e+00\n"
                           "    floadc 7\n"
                           "    freturn\n"
                           "    jump _ifend5\n"
                           "_else5:\n"
                           ".const float 0x1p+2  ; 4.000000e+00\n"
                           "    floadc 8\n"
                           "    freturn\n"
                           "_ifend5:\n"
                           "lf1_retbool:\n"
                           "    bloadc_t\n"
                           "    breturn\n"
                           "cast:\n"
                           "    esr 3\n"
                           "    bloadc_t\n"
                           "    branch_f _pfalse8\n"
                           "    iloadc_1\n"
                           "    jump _pend8\n"
                           "_pfalse8:\n"
                           "    iloadc_0\n"
                           "_pend8:\n"
                           "    i2f\n"
                           "    floadc_0\n"
                           "    fne\n"
                           "    branch_f _pfalse7\n"
                           "    bloadc_t\n"
                           "    jump _pend7\n"
                           "_pfalse7:\n"
                           "    bloadc_f\n"
                           "_pend7:\n"
                           "    branch_f _pfalse6\n"
                           "    iloadc_1\n"
                           "    jump _pend6\n"
                           "_pfalse6:\n"
                           "    iloadc_0\n"
                           "_pend6:\n"
                           "    istore 0\n"
                           "    iloadc 0\n"
                           "    iloadc 0\n"
                           "    iadd\n"
                           "    iloadc 2\n"
                           "    iadd\n"
                           ".const int 0x8  ; 8\n"
                           "    iloadc 9\n"
                           "    iadd\n"
                           "    iloadc_0\n"
                           "    ine\n"
                           "    branch_f _pfalse9\n"
                           "    bloadc_t\n"
                           "    jump _pend9\n"
                           "_pfalse9:\n"
                           "    bloadc_f\n"
                           "_pend9:\n"
                           "    bstore 1\n"
                           "    iload_0\n"
                           "    iloadc 0\n"
                           "    ilt\n"
                           "    branch_f _pfalse11\n"
                           ".const int 0xa  ; 10\n"
                           "    iloadc 10\n"
                           "    iload_0\n"
                           "    igt\n"
                           "    jump _pend11\n"
                           "_pfalse11:\n"
                           "    bloadc_f\n"
                           "_pend11:\n"
                           "    branch_f _pfalse10\n"
                           "    floadc_1\n"
                           "    jump _pend10\n"
                           "_pfalse10:\n"
                           "    floadc_0\n"
                           "_pend10:\n"
                           "    fstore 2\n"
                           "    return\n"
                           "array:\n"
                           "    esr 20\n"
                           "    iloadc 1\n"
                           "    iloadc 6\n"
                           "    imul\n"
                           "    istore 3\n"
                           "    iload_3\n"
                           "    fnewa\n"
                           "    astore 4\n"
                           "    floadc_1\n"
                           "    iloadc_0\n"
                           "    iloadc 6\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aload 4\n"
                           "    fstorea\n"
                           ".const float 0x1p+1  ; 2.000000e+00\n"
                           "    floadc 11\n"
                           "    iloadc_0\n"
                           "    iloadc 6\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload 4\n"
                           "    fstorea\n"
                           "    floadc 4\n"
                           "    iloadc_1\n"
                           "    iloadc 6\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aload 4\n"
                           "    fstorea\n"
                           "    floadc 8\n"
                           "    iloadc_1\n"
                           "    iloadc 6\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload 4\n"
                           "    fstorea\n"
                           "    floadc 3\n"
                           "    iloadc 6\n"
                           "    iloadc 6\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aload 4\n"
                           "    fstorea\n"
                           "    floadc 7\n"
                           "    iloadc 6\n"
                           "    iloadc 6\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload 4\n"
                           "    fstorea\n"
                           "    iloadc 6\n"
                           "    iloadc 0\n"
                           "    imul\n"
                           "    istore 5\n"
                           "    iload 5\n"
                           "    fnewa\n"
                           "    astore 6\n"
                           "    floadc_1\n"
                           "    iloadc_0\n"
                           "    iloadc 0\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aload 6\n"
                           "    fstorea\n"
                           "    floadc 11\n"
                           "    iloadc_0\n"
                           "    iloadc 0\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload 6\n"
                           "    fstorea\n"
                           "    floadc 4\n"
                           "    iloadc_0\n"
                           "    iloadc 0\n"
                           "    imul\n"
                           "    iloadc 6\n"
                           "    iadd\n"
                           "    aload 6\n"
                           "    fstorea\n"
                           "    floadc 8\n"
                           "    iloadc_0\n"
                           "    iloadc 0\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    aload 6\n"
                           "    fstorea\n"
                           "    floadc 3\n"
                           "    iloadc_0\n"
                           "    iloadc 0\n"
                           "    imul\n"
                           ".const int 0x4  ; 4\n"
                           "    iloadc 12\n"
                           "    iadd\n"
                           "    aload 6\n"
                           "    fstorea\n"
                           "    floadc 7\n"
                           "    iloadc_1\n"
                           "    iloadc 0\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aload 6\n"
                           "    fstorea\n"
                           "    floadc 5\n"
                           "    iloadc_1\n"
                           "    iloadc 0\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload 6\n"
                           "    fstorea\n"
                           ".const float 0x1p+3  ; 8.000000e+00\n"
                           "    floadc 13\n"
                           "    iloadc_1\n"
                           "    iloadc 0\n"
                           "    imul\n"
                           "    iloadc 6\n"
                           "    iadd\n"
                           "    aload 6\n"
                           "    fstorea\n"
                           ".const float 0x1.2p+3  ; 9.000000e+00\n"
                           "    floadc 14\n"
                           "    iloadc_1\n"
                           "    iloadc 0\n"
                           "    imul\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    aload 6\n"
                           "    fstorea\n"
                           ".const float 0x1.4p+3  ; 1.000000e+01\n"
                           "    floadc 15\n"
                           "    iloadc_1\n"
                           "    iloadc 0\n"
                           "    imul\n"
                           "    iloadc 12\n"
                           "    iadd\n"
                           "    aload 6\n"
                           "    fstorea\n"
                           ".const int 0x6  ; 6\n"
                           "    iloadc 16\n"
                           "    istore 7\n"
                           "    iload 7\n"
                           "    inewa\n"
                           "    astore 8\n"
                           "    iloadc_1\n"
                           "    iloadc_0\n"
                           "    aload 8\n"
                           "    istorea\n"
                           "    iloadc 6\n"
                           "    iloadc_1\n"
                           "    aload 8\n"
                           "    istorea\n"
                           "    iloadc 1\n"
                           "    iloadc 6\n"
                           "    aload 8\n"
                           "    istorea\n"
                           "    iloadc 12\n"
                           "    iloadc 1\n"
                           "    aload 8\n"
                           "    istorea\n"
                           "    iloadc 0\n"
                           "    iloadc 12\n"
                           "    aload 8\n"
                           "    istorea\n"
                           "    iloadc 16\n"
                           "    iloadc 0\n"
                           "    aload 8\n"
                           "    istorea\n"
                           "    iloadc_1\n"
                           "    iloadc_1\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    imul\n"
                           "    istore 9\n"
                           "    iload 9\n"
                           "    bnewa\n"
                           "    astore 10\n"
                           "    bloadc_t\n"
                           "    iloadc_0\n"
                           "    iloadc_1\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc_1\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc_1\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    iloadc_1\n"
                           "    imul\n"
                           "    iloadc_0\n"
                           "    iadd\n"
                           "    aload 10\n"
                           "    bstorea\n"
                           "    iloadc 1\n"
                           "    iloadc 6\n"
                           "    imul\n"
                           "    istore 11\n"
                           "    iload 11\n"
                           "    fnewa\n"
                           "    astore 14\n"
                           "    floadc_1\n"
                           "    fstore 12\n"
                           "    iloadc_0\n"
                           "    istore 13\n"
                           "_for0:\n"
                           "    iload 13\n"
                           "    iload 11\n"
                           "    ilt\n"
                           "    branch_f _endfor0\n"
                           "    fload 12\n"
                           "    iload 13\n"
                           "    aload 14\n"
                           "    fstorea\n"
                           "    iinc_1 13\n"
                           "    jump _for0\n"
                           "_endfor0:\n"
                           "    iloadc 16\n"
                           "    istore 15\n"
                           "    iload 15\n"
                           "    inewa\n"
                           "    astore 18\n"
                           "    iloadc 6\n"
                           "    istore 16\n"
                           "    iloadc_0\n"
                           "    istore 17\n"
                           "_for1:\n"
                           "    iload 17\n"
                           "    iload 15\n"
                           "    ilt\n"
                           "    branch_f _endfor1\n"
                           "    iload 16\n"
                           "    iload 17\n"
                           "    aload 18\n"
                           "    istorea\n"
                           "    iinc_1 17\n"
                           "    jump _for1\n"
                           "_endfor1:\n"
                           "    iloadc_1\n"
                           "    iloadc_1\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    imul\n"
                           "    istore 19\n"
                           "    iload 19\n"
                           "    bnewa\n"
                           "    astore 22\n"
                           "    bloadc_t\n"
                           "    bstore 20\n"
                           "    iloadc_0\n"
                           "    istore 21\n"
                           "_for2:\n"
                           "    iload 21\n"
                           "    iload 19\n"
                           "    ilt\n"
                           "    branch_f _endfor2\n"
                           "    bload 20\n"
                           "    iload 21\n"
                           "    aload 22\n"
                           "    bstorea\n"
                           "    iinc_1 21\n"
                           "    jump _for2\n"
                           "_endfor2:\n"
                           "    floadc_1\n"
                           "    iloadc_0\n"
                           "    iload_0\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload_2\n"
                           "    fstorea\n"
                           "    isrg\n"
                           "    iload_0\n"
                           "    iload_1\n"
                           "    aload_2\n"
                           "    jsr 3 array\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, NestedFor)
{
    SetUp("nested_for/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".exportfun \"test\" void test\n"
                           "test:\n"
                           "    esr 5\n"
                           "    iloadc_0\n"
                           "    istore 1\n"
                           "_for0:\n"
                           "    iload_1\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 0\n"
                           "    ilt\n"
                           "    branch_f _endfor0\n"
                           "    iload_1\n"
                           "    istore 0\n"
                           "    iloadc_0\n"
                           "    istore 2\n"
                           "_for1:\n"
                           "    iload_2\n"
                           "    iloadc 0\n"
                           "    ilt\n"
                           "    branch_f _endfor1\n"
                           "    iload_2\n"
                           "    istore 0\n"
                           "    iloadc_0\n"
                           "    istore 3\n"
                           "_for2:\n"
                           "    iload_3\n"
                           "    iloadc 0\n"
                           "    ilt\n"
                           "    branch_f _endfor2\n"
                           "    iload_3\n"
                           "    istore 0\n"
                           "    iloadc_0\n"
                           "    istore 4\n"
                           "_for3:\n"
                           "    iload 4\n"
                           "    iloadc 0\n"
                           "    ilt\n"
                           "    branch_f _endfor3\n"
                           "    iload 4\n"
                           "    istore 0\n"
                           "    iloadc_1\n"
                           "    iinc_1 4\n"
                           "    jump _for3\n"
                           "_endfor3:\n"
                           "    iload_3\n"
                           "    istore 0\n"
                           "    iloadc_1\n"
                           "    iinc_1 3\n"
                           "    jump _for2\n"
                           "_endfor2:\n"
                           "    iload_2\n"
                           "    istore 0\n"
                           "    iloadc_1\n"
                           "    iinc_1 2\n"
                           "    jump _for1\n"
                           "_endfor1:\n"
                           "    iload_1\n"
                           "    istore 0\n"
                           "    iloadc_1\n"
                           "    iinc_1 1\n"
                           "    jump _for0\n"
                           "_endfor0:\n"
                           "    iloadc_0\n"
                           "    istore 0\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, BadMain)
{
    SetUp("bad_main/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "main:\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, SameIdentifierFunDefVarDecValid)
{
    SetUp("same_identifier/fundef_vardec/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "fun_one:\n"
                           "    iload_0\n"
                           "    ireturn\n"
                           "lf0_param0:\n"
                           "    esr 1\n"
                           "    iloadc_0\n"
                           "    istore 0\n"
                           "    return\n"
                           "fun_two:\n"
                           "    floadc_1\n"
                           "    freturn\n"
                           "lf1_nested:\n"
                           "    esr 2\n"
                           "    iloadc_0\n"
                           "    istore 1\n"
                           "    iloadc_1\n"
                           "    istore 2\n"
                           "    return\n"
                           "fun_three:\n"
                           "    esr 1\n"
                           "    bloadc_t\n"
                           "    breturn\n"
                           "lf2_shadow:\n"
                           "    esr 1\n"
                           "    iloadc_1\n"
                           "    istore 1\n"
                           "    iload_1\n"
                           "    ireturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, SameIdentifierParamNestedParam)
{
    SetUp("same_identifier/param_nested_param/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "fun_one:\n"
                           "    iload_0\n"
                           "    ireturn\n"
                           "lf0_nested_fun_one:\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, ProcCallContext)
{
    SetUp("proc_call/context/main.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "fun:\n"
                           "    iload_0\n"
                           "    ireturn\n"
                           "test:\n"
                           "    esr 1\n"
                           "    isrg\n"
                           "    iloadc_1\n"
                           "    jsr 1 fun\n"
                           "    isrg\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 0\n"
                           "    jsr 1 fun\n"
                           "    iadd\n"
                           "    istore 0\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_Binop)
{
    SetUp("testsuite_public/basic/check_success/binops.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "foo:\n"
                           "    esr 6\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 0\n"
                           "    istore 1\n"
                           ".const int 0x3  ; 3\n"
                           "    iloadc 1\n"
                           ".const int 0x4  ; 4\n"
                           "    iloadc 2\n"
                           "    iadd\n"
                           "    istore 2\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 3\n"
                           ".const int 0x6  ; 6\n"
                           "    iloadc 4\n"
                           "    imul\n"
                           "    istore 3\n"
                           ".const int 0x7  ; 7\n"
                           "    iloadc 5\n"
                           ".const int 0x8  ; 8\n"
                           "    iloadc 6\n"
                           "    irem\n"
                           "    istore 4\n"
                           "    iload_2\n"
                           "    iload_3\n"
                           "    iadd\n"
                           "    iload 4\n"
                           "    iload_1\n"
                           "    imul\n"
                           "    isub\n"
                           "    istore 5\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_Boolop)
{
    SetUp("testsuite_public/basic/check_success/boolop.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "f:\n"
                           "    esr 23\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 0\n"
                           ".const int 0x3  ; 3\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           ".const int 0x4  ; 4\n"
                           "    iloadc 2\n"
                           "    iadd\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 3\n"
                           "    iadd\n"
                           "    istore 0\n"
                           ".const float 0x1.38p+5  ; 3.900000e+01\n"
                           "    floadc 4\n"
                           ".const float 0x1.8p+1  ; 3.000000e+00\n"
                           "    floadc 5\n"
                           "    fadd\n"
                           ".const float 0x1.5p+4  ; 2.100000e+01\n"
                           "    floadc 6\n"
                           "    fadd\n"
                           "    fstore 1\n"
                           "    bloadc_f\n"
                           "    bloadc_f\n"
                           "    badd\n"
                           "    bstore 2\n"
                           "    iloadc 0\n"
                           "    iloadc 1\n"
                           "    isub\n"
                           "    iloadc 2\n"
                           "    isub\n"
                           "    iloadc 3\n"
                           "    isub\n"
                           "    istore 3\n"
                           "    floadc 4\n"
                           "    floadc 5\n"
                           "    fsub\n"
                           "    floadc 6\n"
                           "    fsub\n"
                           "    fstore 4\n"
                           "    iloadc 0\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    imul\n"
                           "    istore 5\n"
                           ".const float 0x1.91eb851eb851fp+1  ; 3.140000e+00\n"
                           "    floadc 7\n"
                           ".const float 0x1p+1  ; 2.000000e+00\n"
                           "    floadc 8\n"
                           "    fmul\n"
                           "    fstore 6\n"
                           "    bloadc_t\n"
                           "    bloadc_f\n"
                           "    bmul\n"
                           "    bstore 7\n"
                           "    iloadc 2\n"
                           "    iloadc 1\n"
                           "    idiv\n"
                           "    istore 8\n"
                           ".const int 0x6  ; 6\n"
                           "    iloadc 9\n"
                           "    iloadc_0\n"
                           "    idiv\n"
                           "    istore 9\n"
                           ".const float 0x1.4p+2  ; 5.000000e+00\n"
                           "    floadc 10\n"
                           "    floadc 8\n"
                           "    fdiv\n"
                           "    fstore 10\n"
                           ".const float 0x1.2p+3  ; 9.000000e+00\n"
                           "    floadc 11\n"
                           "    floadc_0\n"
                           "    fdiv\n"
                           "    fstore 11\n"
                           ".const int 0xc  ; 12\n"
                           "    iloadc 12\n"
                           ".const int 0x8  ; 8\n"
                           "    iloadc 13\n"
                           "    irem\n"
                           "    iloadc 1\n"
                           "    irem\n"
                           "    istore 12\n"
                           ".const int 0x14  ; 20\n"
                           "    iloadc 14\n"
                           "    iloadc 14\n"
                           "    ilt\n"
                           "    bstore 13\n"
                           "    floadc 5\n"
                           ".const float 0x1.8666666666666p+2  ; 6.100000e+00\n"
                           "    floadc 15\n"
                           "    flt\n"
                           "    bstore 14\n"
                           "    iloadc 14\n"
                           "    iloadc 14\n"
                           "    ile\n"
                           "    bstore 15\n"
                           "    floadc 5\n"
                           "    floadc 15\n"
                           "    fle\n"
                           "    bstore 16\n"
                           ".const int 0x3c  ; 60\n"
                           "    iloadc 16\n"
                           ".const int 0x32  ; 50\n"
                           "    iloadc 17\n"
                           "    ilt\n"
                           "    branch_f _pfalse0\n"
                           "    bloadc_t\n"
                           "    jump _pend0\n"
                           "_pfalse0:\n"
                           ".const int 0x1e  ; 30\n"
                           "    iloadc 18\n"
                           ".const int 0xa  ; 10\n"
                           "    iloadc 19\n"
                           "    igt\n"
                           "_pend0:\n"
                           "    bstore 17\n"
                           "    floadc 5\n"
                           "    floadc 8\n"
                           "    fgt\n"
                           "    bstore 18\n"
                           "    iloadc 13\n"
                           "    iloadc 13\n"
                           "    ine\n"
                           "    bstore 19\n"
                           "    iloadc 13\n"
                           "    iloadc 13\n"
                           "    ieq\n"
                           "    bstore 20\n"
                           ".const float 0x1.3333333333333p+0  ; 1.200000e+00\n"
                           "    floadc 20\n"
                           ".const float 0x1.0cccccccccccdp+1  ; 2.100000e+00\n"
                           "    floadc 21\n"
                           "    fne\n"
                           "    bstore 21\n"
                           "    bloadc_t\n"
                           "    bloadc_f\n"
                           "    bne\n"
                           "    bstore 22\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);

    ASSERT_THAT(err_output, testing::HasSubstr("warning: Division by zero"));
}

TEST_F(GenerationTest, Suite_Basic_CommentMultiline)
{
    SetUp("testsuite_public/basic/check_success/comment_multiline.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".global int\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_CommentSingleline)
{
    SetUp("testsuite_public/basic/check_success/comment_singleline.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".global int\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_DoWhile)
{
    SetUp("testsuite_public/basic/check_success/do_while.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "test_do_while2:\n"
                           "    esr 2\n"
                           "    iloadc_0\n"
                           "    istore 0\n"
                           ".const int 0xa  ; 10\n"
                           "    iloadc 0\n"
                           "    istore 1\n"
                           "_while0:\n"
                           "    iinc_1 0\n"
                           "    idec_1 1\n"
                           "    iload_0\n"
                           "    iload_1\n"
                           "    ile\n"
                           "    branch_t _while0\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_EarlyReturn)
{
    SetUp("testsuite_public/basic/check_success/early_return.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "foo:\n"
                           "    esr 1\n"
                           "    iloadc_1\n"
                           "    istore 1\n"
                           "    iload_0\n"
                           "    iloadc_1\n"
                           "    igt\n"
                           "    branch_f _ifend0\n"
                           "    return\n"
                           "_ifend0:\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 0\n"
                           "    istore 1\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_ExternVar)
{
    SetUp("testsuite_public/basic/check_success/extern_var.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".importvar \"pi\" float\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_NoReturn)
{
    SetUp("testsuite_public/basic/check_success/no_return.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "baz:\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_ParamsFuncall)
{
    SetUp("testsuite_public/basic/check_success/params_funcall.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "foo:\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "    ipop\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    ireturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_ParamsSimple)
{
    SetUp("testsuite_public/basic/check_success/params_simple.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "func:\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_ParseAssign)
{
    SetUp("testsuite_public/basic/check_success/parse_assign.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".global int\n"
                           "foo:\n"
                           "    esr 1\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           "    iloadc_1\n"
                           "    istoreg 0\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_ParseDoWhile)
{
    SetUp("testsuite_public/basic/check_success/parse_do_while.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "foo:\n"
                           "_while0:\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "    bloadc_t\n"
                           "    branch_t _while0\n"
                           "_while1:\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "    bloadc_f\n"
                           "    branch_t _while1\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_ParseFor)
{
    SetUp("testsuite_public/basic/check_success/parse_for.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "foo:\n"
                           "    esr 5\n"
                           "    iloadc_0\n"
                           "    istore 0\n"
                           "_for0:\n"
                           "    iload_0\n"
                           ".const int 0xa  ; 10\n"
                           "    iloadc 0\n"
                           "    ilt\n"
                           "    branch_f _endfor0\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "    iinc_1 0\n"
                           "    jump _for0\n"
                           "_endfor0:\n"
                           "    iloadc_0\n"
                           "    istore 1\n"
                           "_for1:\n"
                           "    iload_1\n"
                           "    iloadc 0\n"
                           "    ilt\n"
                           "    branch_f _endfor1\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "    iinc_1 1\n"
                           "    jump _for1\n"
                           "_endfor1:\n"
                           "    iloadc_0\n"
                           "    istore 3\n"
                           "    iloadc_1\n"
                           "    ineg\n"
                           "    istore 4\n"
                           "    iloadc 0\n"
                           "    istore 2\n"
                           "    iload_3\n"
                           "    iload_2\n"
                           "    isub\n"
                           "    iload 4\n"
                           "    idiv\n"
                           "    istore 3\n"
                           "    iload_3\n"
                           "    iload 4\n"
                           "    irem\n"
                           "    iloadc_0\n"
                           "    ieq\n"
                           "    branch_t _for2\n"
                           "    iinc_1 3\n"
                           "_for2:\n"
                           "    iload_3\n"
                           "    iloadc_0\n"
                           "    igt\n"
                           "    branch_f _endfor2\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "    idec_1 3\n"
                           "    iload_2\n"
                           "    iload 4\n"
                           "    iadd\n"
                           "    istore 2\n"
                           "    jump _for2\n"
                           "_endfor2:\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_ParseFunbody)
{
    SetUp("testsuite_public/basic/check_success/parse_funbody.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "vardec:\n"
                           "    esr 1\n"
                           "    return\n"
                           "vardec_stat:\n"
                           "    esr 1\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           "    return\n"
                           "vardec_ret:\n"
                           "    esr 1\n"
                           "    iloadc 0\n"
                           "    ireturn\n"
                           "vardec_stat_ret:\n"
                           "    esr 1\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    ireturn\n"
                           "stat_ret:\n"
                           "    isrg\n"
                           "    jsr 0 vardec\n"
                           "    iloadc 0\n"
                           "    ireturn\n"
                           "ret:\n"
                           "    iloadc 0\n"
                           "    ireturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_ParseFuncall)
{
    SetUp("testsuite_public/basic/check_success/parse_funcall.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "foo:\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_ParseGlobaldec)
{
    SetUp("testsuite_public/basic/check_success/parse_globaldec.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".importvar \"a\" bool\n"
                           ".importvar \"b\" int\n"
                           ".importvar \"c\" float\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_ParseGlobaldef)
{
    SetUp("testsuite_public/basic/check_success/parse_globaldef.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".global int\n"
                           ".global float\n"
                           ".global bool\n"
                           ".global int\n"
                           ".global float\n"
                           ".global bool\n"
                           ".global int\n"
                           ".exportvar \"a2\" 6\n"
                           ".global float\n"
                           ".exportvar \"b2\" 7\n"
                           ".global bool\n"
                           ".exportvar \"c2\" 8\n"
                           ".global int\n"
                           ".exportvar \"d2\" 9\n"
                           ".global float\n"
                           ".exportvar \"e2\" 10\n"
                           ".global bool\n"
                           ".exportvar \"f2\" 11\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           ".const int 0x141  ; 321\n"
                           "    iloadc 0\n"
                           "    istoreg 3\n"
                           "    floadc_1\n"
                           "    fstoreg 4\n"
                           "    bloadc_f\n"
                           "    bstoreg 5\n"
                           "    iloadc 0\n"
                           "    istoreg 9\n"
                           "    floadc_1\n"
                           "    fstoreg 10\n"
                           "    bloadc_f\n"
                           "    bstoreg 11\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_ParseIfElse)
{
    SetUp("testsuite_public/basic/check_success/parse_if_else.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "foo:\n"
                           "    bloadc_t\n"
                           "    branch_f _else0\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "    jump _ifend0\n"
                           "_else0:\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "_ifend0:\n"
                           "    bloadc_f\n"
                           "    branch_f _else1\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "    jump _ifend1\n"
                           "_else1:\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "_ifend1:\n"
                           "    bloadc_t\n"
                           "    branch_f _else2\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "    jump _ifend2\n"
                           "_else2:\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "_ifend2:\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_IntegerOutOfRange)
{
    SetUp("testsuite_public/basic/check_error/integer_out_of_range.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".global int\n"
                           ".importfun \"printInt\" void int\n"
                           ".exportfun \"main\" int main\n"
                           "main:\n"
                           "    isrg\n"
                           "    iloadg 0\n"
                           "    jsre 0\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           ".const int 0x7fffffff  ; 2147483647\n"
                           "    iloadc 0\n"
                           "    istoreg 0\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_ParseOperators)
{
    SetUp("testsuite_public/basic/check_success/parse_operators.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "foo:\n"
                           "    esr 2\n"
                           "    iloadc_1\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 0\n"
                           "    iadd\n"
                           "    istore 0\n"
                           "    idec_1 0\n"
                           "    iload_0\n"
                           ".const int 0x2d  ; 45\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           ".const int 0x9  ; 9\n"
                           "    iloadc 2\n"
                           "    idiv\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           ".const int 0x4  ; 4\n"
                           "    iloadc 3\n"
                           "    irem\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    iloadc_1\n"
                           "    ilt\n"
                           "    bstore 1\n"
                           "    iload_0\n"
                           "    iloadc 0\n"
                           "    igt\n"
                           "    bstore 1\n"
                           "    iload_0\n"
                           ".const int 0x3  ; 3\n"
                           "    iloadc 4\n"
                           "    ile\n"
                           "    bstore 1\n"
                           "    iload_0\n"
                           "    iloadc 3\n"
                           "    ige\n"
                           "    bstore 1\n"
                           "    iload_0\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 5\n"
                           "    ieq\n"
                           "    bstore 1\n"
                           "    iload_0\n"
                           ".const int 0x6  ; 6\n"
                           "    iloadc 6\n"
                           "    ine\n"
                           "    bstore 1\n"
                           "    iload_0\n"
                           "    iloadc 6\n"
                           "    ine\n"
                           "    branch_f _pfalse0\n"
                           "    iload_0\n"
                           "    iloadc 3\n"
                           "    ige\n"
                           "    jump _pend0\n"
                           "_pfalse0:\n"
                           "    bloadc_f\n"
                           "_pend0:\n"
                           "    bstore 1\n"
                           "    iload_0\n"
                           "    iloadc 6\n"
                           "    ieq\n"
                           "    branch_f _pfalse1\n"
                           "    bloadc_t\n"
                           "    jump _pend1\n"
                           "_pfalse1:\n"
                           "    iload_0\n"
                           "    iloadc 3\n"
                           "    ile\n"
                           "_pend1:\n"
                           "    bstore 1\n"
                           "    iload_0\n"
                           "    ineg\n"
                           "    istore 0\n"
                           "    bload_1\n"
                           "    bnot\n"
                           "    bstore 1\n"
                           "    iload_0\n"
                           "    iloadc_1\n"
                           "    ineg\n"
                           "    isub\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    ineg\n"
                           "    ineg\n"
                           "    ineg\n"
                           "    ineg\n"
                           "    ineg\n"
                           "    ineg\n"
                           "    istore 0\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_ParseTypecast)
{
    SetUp("testsuite_public/basic/check_success/parse_typecast.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "foo:\n"
                           "    esr 3\n"
                           "    floadc_1\n"
                           "    f2i\n"
                           "    istore 0\n"
                           "    iloadc_1\n"
                           "    i2f\n"
                           "    fstore 1\n"
                           "    iloadc_1\n"
                           "    iloadc_0\n"
                           "    ine\n"
                           "    branch_f _pfalse0\n"
                           "    bloadc_t\n"
                           "    jump _pend0\n"
                           "_pfalse0:\n"
                           "    bloadc_f\n"
                           "_pend0:\n"
                           "    bstore 2\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_ParseVardec)
{
    SetUp("testsuite_public/basic/check_success/parse_vardec.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "foo:\n"
                           "    esr 6\n"
                           "    bloadc_t\n"
                           "    bstore 3\n"
                           "    iloadc_1\n"
                           "    istore 4\n"
                           "    floadc_1\n"
                           "    fstore 5\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Basic_VardecInit)
{
    SetUp("testsuite_public/basic/check_success/vardec_init.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "testVarInits:\n"
                           "    esr 4\n"
                           ".const int 0x3  ; 3\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 1\n"
                           "    istore 1\n"
                           "    iload_0\n"
                           "    iload_1\n"
                           "    iadd\n"
                           "    istore 2\n"
                           "    iload_0\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 2\n"
                           "    iadd\n"
                           "    istore 3\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Arrays_ExternArrayArg)
{
    SetUp("testsuite_public/arrays/check_success/extern_array_arg.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".importvar \"__dim0_arr\" int\n"
                           ".importvar \"arr\" int[]\n"
                           "foo:\n"
                           "    return\n"
                           ".exportfun \"main\" int main\n"
                           "main:\n"
                           "    isrg\n"
                           "    iloade 0\n"
                           "    aloade 1\n"
                           "    jsr 2 foo\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Arrays_LocalArraydef)
{
    SetUp("testsuite_public/arrays/check_success/local_arraydef.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "func:\n"
                           "    esr 6\n"
                           ".const int 0xa  ; 10\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    inewa\n"
                           "    astore 1\n"
                           ".const int 0x14  ; 20\n"
                           "    iloadc 1\n"
                           ".const int 0x1e  ; 30\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    istore 2\n"
                           "    iload_2\n"
                           "    inewa\n"
                           "    astore 3\n"
                           ".const int 0x4  ; 4\n"
                           "    iloadc 3\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 4\n"
                           "    imul\n"
                           ".const int 0x6  ; 6\n"
                           "    iloadc 5\n"
                           "    imul\n"
                           "    istore 4\n"
                           "    iload 4\n"
                           "    inewa\n"
                           "    astore 5\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Arrays_ScanVectorMatrix)
{
    SetUp("testsuite_public/arrays/check_success/scan_vector_matrix.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".importfun \"scanInt\" int\n"
                           ".importfun \"scanFloat\" float\n"
                           ".importfun \"printInt\" void int\n"
                           ".importfun \"printFloat\" void float\n"
                           "scan_vector:\n"
                           "    esr 2\n"
                           "    iload_0\n"
                           "    istore 3\n"
                           "    iloadc_0\n"
                           "    istore 2\n"
                           "_for0:\n"
                           "    iload_2\n"
                           "    iload_3\n"
                           "    ilt\n"
                           "    branch_f _endfor0\n"
                           "    isrg\n"
                           "    jsre 1\n"
                           "    iload_2\n"
                           "    aload_1\n"
                           "    fstorea\n"
                           "    iinc_1 2\n"
                           "    jump _for0\n"
                           "_endfor0:\n"
                           "    return\n"
                           "scan_matrix:\n"
                           "    esr 4\n"
                           "    iload_1\n"
                           "    istore 5\n"
                           "    iloadc_0\n"
                           "    istore 3\n"
                           "_for1:\n"
                           "    iload_3\n"
                           "    iload 5\n"
                           "    ilt\n"
                           "    branch_f _endfor1\n"
                           "    iload_0\n"
                           "    istore 6\n"
                           "    iloadc_0\n"
                           "    istore 4\n"
                           "_for2:\n"
                           "    iload 4\n"
                           "    iload 6\n"
                           "    ilt\n"
                           "    branch_f _endfor2\n"
                           "    isrg\n"
                           "    jsre 1\n"
                           "    iload_3\n"
                           "    iload_0\n"
                           "    imul\n"
                           "    iload 4\n"
                           "    iadd\n"
                           "    aload_2\n"
                           "    fstorea\n"
                           "    iinc_1 4\n"
                           "    jump _for2\n"
                           "_endfor2:\n"
                           "    iinc_1 3\n"
                           "    jump _for1\n"
                           "_endfor1:\n"
                           "    return\n"
                           ".exportfun \"main\" int main\n"
                           "main:\n"
                           "    esr 2\n"
                           ".const int 0x3  ; 3\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           "    iloadc 0\n"
                           "    istore 1\n"
                           "    iload_1\n"
                           "    iloadc_1\n"
                           "    ieq\n"
                           "    branch_f _pfalse1\n"
                           "    iload_0\n"
                           "    iloadc_1\n"
                           "    ige\n"
                           "    jump _pend1\n"
                           "_pfalse1:\n"
                           "    bloadc_f\n"
                           "_pend1:\n"
                           "    branch_f _else0\n"
                           "    isrl\n"
                           "    jsr 0 lf0_do_vector\n"
                           "    jump _ifend0\n"
                           "_else0:\n"
                           "    iload_1\n"
                           "    iloadc_1\n"
                           "    igt\n"
                           "    branch_f _pfalse3\n"
                           "    iload_0\n"
                           "    iloadc_1\n"
                           "    ige\n"
                           "    jump _pend3\n"
                           "_pfalse3:\n"
                           "    bloadc_f\n"
                           "_pend3:\n"
                           "    branch_f _ifend2\n"
                           "    isrl\n"
                           "    jsr 0 lf1_do_matrix\n"
                           "_ifend2:\n"
                           "_ifend0:\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           "lf0_do_vector:\n"
                           "    esr 2\n"
                           "    iloadn 1 0\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    fnewa\n"
                           "    astore 1\n"
                           "    isrg\n"
                           "    iloadn 1 0\n"
                           "    aload_1\n"
                           "    jsr 2 scan_vector\n"
                           "    return\n"
                           "lf1_do_matrix:\n"
                           "    esr 2\n"
                           "    iloadn 1 0\n"
                           "    iloadn 1 1\n"
                           "    imul\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    fnewa\n"
                           "    astore 1\n"
                           "    isrg\n"
                           "    iloadn 1 1\n"
                           "    iloadn 1 0\n"
                           "    aload_1\n"
                           "    jsr 3 scan_matrix\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_Arrays_Scopes)
{
    SetUp("testsuite_public/arrays/check_success/scopes.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".importfun \"printInt\" void int\n"
                           ".importfun \"printNewlines\" void int\n"
                           ".global int\n"
                           ".global int\n"
                           ".global int[]\n"
                           ".importvar \"__dim0_d\" int\n"
                           ".importvar \"d\" int[]\n"
                           "foo:\n"
                           "    esr 3\n"
                           "    iloadg 0\n"
                           "    iloadg 1\n"
                           "    iadd\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    istore 0\n"
                           "    iloade 0\n"
                           "    istore 1\n"
                           "    iinc_1 0\n"
                           "    iload_1\n"
                           "    iloadc_1\n"
                           "    isub\n"
                           "    istore 2\n"
                           "    isrl\n"
                           ".const int 0x4  ; 4\n"
                           "    iloadc 0\n"
                           "    iload_0\n"
                           "    iload_2\n"
                           "    aloade 1\n"
                           "    iloada\n"
                           "    iadd\n"
                           "    aloadg 2\n"
                           "    jsr 3 lf0_baz\n"
                           "    ireturn\n"
                           "lf0_baz:\n"
                           "    esr 1\n"
                           "    iload_1\n"
                           "    iload_0\n"
                           "    iadd\n"
                           "    istore 3\n"
                           "    iload_3\n"
                           "    iload_1\n"
                           "    aload_2\n"
                           "    iloada\n"
                           "    iadd\n"
                           "    ireturn\n"
                           "bar:\n"
                           "    esr 2\n"
                           "    iloadg 1\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    ireturn\n"
                           "baz:\n"
                           "    esr 3\n"
                           "    isrg\n"
                           "    iload_0\n"
                           "    jsre 0\n"
                           "    iloadc_1\n"
                           "    istore 1\n"
                           "_for0:\n"
                           "    iload_1\n"
                           ".const int 0xa  ; 10\n"
                           "    iloadc 1\n"
                           "    ilt\n"
                           "    branch_f _endfor0\n"
                           "    isrg\n"
                           "    iload_1\n"
                           "    jsre 0\n"
                           "    iloadc_1\n"
                           "    istore 2\n"
                           "_for1:\n"
                           "    iload_2\n"
                           "    iloadc 1\n"
                           "    ilt\n"
                           "    branch_f _endfor1\n"
                           "    isrg\n"
                           "    iload_2\n"
                           "    jsre 0\n"
                           "    iinc_1 2\n"
                           "    jump _for1\n"
                           "_endfor1:\n"
                           "    isrg\n"
                           "    iload_1\n"
                           "    jsre 0\n"
                           "    iinc_1 1\n"
                           "    jump _for0\n"
                           "_endfor0:\n"
                           "    isrg\n"
                           "    iload_0\n"
                           "    jsre 0\n"
                           "    return\n"
                           ".exportfun \"main\" int main\n"
                           "main:\n"
                           "    isrg\n"
                           "    isrg\n"
                           "    jsr 0 foo\n"
                           "    jsre 0\n"
                           "    isrg\n"
                           "    iloadc_1\n"
                           "    jsre 1\n"
                           "    isrg\n"
                           "    isrg\n"
                           "    jsr 0 bar\n"
                           "    jsre 0\n"
                           "    isrg\n"
                           "    iloadc_1\n"
                           "    jsre 1\n"
                           "    isrg\n"
                           "    jsr 0 baz\n"
                           "    isrg\n"
                           "    iloadc_1\n"
                           "    jsre 1\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    esr 1\n"
                           "    iloadc_1\n"
                           "    istoreg 0\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 2\n"
                           "    istoreg 1\n"
                           "    iloadc 0\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    inewa\n"
                           "    astoreg 2\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Suite_NestedFuns_LocalFun)
{
    SetUp("testsuite_public/nested_funs/check_success/local_funs.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = "func:\n"
                           "    esr 2\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 0\n"
                           "    ineg\n"
                           ".const int 0xa  ; 10\n"
                           "    iloadc 1\n"
                           "    iadd\n"
                           "    istore 0\n"
                           "    iloadc 0\n"
                           "    iloadc 1\n"
                           "    isub\n"
                           "    istore 1\n"
                           "    return\n"
                           "lf0_f:\n"
                           "    return\n"
                           "lf1_g:\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Functional_Assignment01_Array)
{
    SetUp("functional/assignment_01/array.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected =
        ".importfun \"printInt\" void int\n"
        ".importfun \"printFloat\" void float\n"
        ".importfun \"scanInt\" int\n"
        ".importfun \"scanFloat\" float\n"
        ".importfun \"printSpaces\" void int\n"
        ".importfun \"printNewlines\" void int\n"
        ".exportfun \"printIntVec\" void int int[] printIntVec\n"
        "printIntVec:\n"
        "    esr 2\n"
        "    iload_0\n"
        "    istore 3\n"
        "    iloadc_0\n"
        "    istore 2\n"
        "_for0:\n"
        "    iload_2\n"
        "    iload_3\n"
        "    ilt\n"
        "    branch_f _endfor0\n"
        "    isrg\n"
        "    iload_2\n"
        "    aload_1\n"
        "    iloada\n"
        "    jsre 0\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 4\n"
        "    iloadc_1\n"
        "    iinc_1 2\n"
        "    jump _for0\n"
        "_endfor0:\n"
        "    return\n"
        ".exportfun \"printFloatVec\" void int float[] printFloatVec\n"
        "printFloatVec:\n"
        "    esr 2\n"
        "    iload_0\n"
        "    istore 3\n"
        "    iloadc_0\n"
        "    istore 2\n"
        "_for1:\n"
        "    iload_2\n"
        "    iload_3\n"
        "    ilt\n"
        "    branch_f _endfor1\n"
        "    isrg\n"
        "    iload_2\n"
        "    aload_1\n"
        "    floada\n"
        "    jsre 1\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 4\n"
        "    iloadc_1\n"
        "    iinc_1 2\n"
        "    jump _for1\n"
        "_endfor1:\n"
        "    return\n"
        ".exportfun \"printIntMat\" void int int int[] printIntMat\n"
        "printIntMat:\n"
        "    esr 4\n"
        "    iload_1\n"
        "    istore 5\n"
        "    iloadc_0\n"
        "    istore 3\n"
        "_for2:\n"
        "    iload_3\n"
        "    iload 5\n"
        "    ilt\n"
        "    branch_f _endfor2\n"
        "    iload_0\n"
        "    istore 6\n"
        "    iloadc_0\n"
        "    istore 4\n"
        "_for3:\n"
        "    iload 4\n"
        "    iload 6\n"
        "    ilt\n"
        "    branch_f _endfor3\n"
        "    isrg\n"
        "    iload_3\n"
        "    iload_0\n"
        "    imul\n"
        "    iload 4\n"
        "    iadd\n"
        "    aload_2\n"
        "    iloada\n"
        "    jsre 0\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 4\n"
        "    iloadc_1\n"
        "    iinc_1 4\n"
        "    jump _for3\n"
        "_endfor3:\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 5\n"
        "    iloadc_1\n"
        "    iinc_1 3\n"
        "    jump _for2\n"
        "_endfor2:\n"
        "    return\n"
        ".exportfun \"printFloatMat\" void int int float[] printFloatMat\n"
        "printFloatMat:\n"
        "    esr 4\n"
        "    iload_1\n"
        "    istore 5\n"
        "    iloadc_0\n"
        "    istore 3\n"
        "_for4:\n"
        "    iload_3\n"
        "    iload 5\n"
        "    ilt\n"
        "    branch_f _endfor4\n"
        "    iload_0\n"
        "    istore 6\n"
        "    iloadc_0\n"
        "    istore 4\n"
        "_for5:\n"
        "    iload 4\n"
        "    iload 6\n"
        "    ilt\n"
        "    branch_f _endfor5\n"
        "    isrg\n"
        "    iload_3\n"
        "    iload_0\n"
        "    imul\n"
        "    iload 4\n"
        "    iadd\n"
        "    aload_2\n"
        "    floada\n"
        "    jsre 1\n"
        "    iloadc_1\n"
        "    iinc_1 4\n"
        "    jump _for5\n"
        "_endfor5:\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 5\n"
        "    iloadc_1\n"
        "    iinc_1 3\n"
        "    jump _for4\n"
        "_endfor4:\n"
        "    return\n"
        ".exportfun \"scanIntVec\" void int int[] scanIntVec\n"
        "scanIntVec:\n"
        "    esr 2\n"
        "    iload_0\n"
        "    istore 3\n"
        "    iloadc_0\n"
        "    istore 2\n"
        "_for6:\n"
        "    iload_2\n"
        "    iload_3\n"
        "    ilt\n"
        "    branch_f _endfor6\n"
        "    isrg\n"
        "    jsre 2\n"
        "    iload_2\n"
        "    aload_1\n"
        "    istorea\n"
        "    iloadc_1\n"
        "    iinc_1 2\n"
        "    jump _for6\n"
        "_endfor6:\n"
        "    return\n"
        ".exportfun \"scanFloatVec\" void int float[] scanFloatVec\n"
        "scanFloatVec:\n"
        "    esr 2\n"
        "    iload_0\n"
        "    istore 3\n"
        "    iloadc_0\n"
        "    istore 2\n"
        "_for7:\n"
        "    iload_2\n"
        "    iload_3\n"
        "    ilt\n"
        "    branch_f _endfor7\n"
        "    isrg\n"
        "    jsre 3\n"
        "    iload_2\n"
        "    aload_1\n"
        "    fstorea\n"
        "    iloadc_1\n"
        "    iinc_1 2\n"
        "    jump _for7\n"
        "_endfor7:\n"
        "    return\n"
        ".exportfun \"scanIntMat\" void int int int[] scanIntMat\n"
        "scanIntMat:\n"
        "    esr 4\n"
        "    iload_1\n"
        "    istore 5\n"
        "    iloadc_0\n"
        "    istore 3\n"
        "_for8:\n"
        "    iload_3\n"
        "    iload 5\n"
        "    ilt\n"
        "    branch_f _endfor8\n"
        "    iload_0\n"
        "    istore 6\n"
        "    iloadc_0\n"
        "    istore 4\n"
        "_for9:\n"
        "    iload 4\n"
        "    iload 6\n"
        "    ilt\n"
        "    branch_f _endfor9\n"
        "    isrg\n"
        "    jsre 2\n"
        "    iload_3\n"
        "    iload_0\n"
        "    imul\n"
        "    iload 4\n"
        "    iadd\n"
        "    aload_2\n"
        "    istorea\n"
        "    iloadc_1\n"
        "    iinc_1 4\n"
        "    jump _for9\n"
        "_endfor9:\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 5\n"
        "    iloadc_1\n"
        "    iinc_1 3\n"
        "    jump _for8\n"
        "_endfor8:\n"
        "    return\n"
        ".exportfun \"scanFloatMat\" void int int float[] scanFloatMat\n"
        "scanFloatMat:\n"
        "    esr 4\n"
        "    iload_1\n"
        "    istore 5\n"
        "    iloadc_0\n"
        "    istore 3\n"
        "_for10:\n"
        "    iload_3\n"
        "    iload 5\n"
        "    ilt\n"
        "    branch_f _endfor10\n"
        "    iload_0\n"
        "    istore 6\n"
        "    iloadc_0\n"
        "    istore 4\n"
        "_for11:\n"
        "    iload 4\n"
        "    iload 6\n"
        "    ilt\n"
        "    branch_f _endfor11\n"
        "    isrg\n"
        "    jsre 3\n"
        "    iload_3\n"
        "    iload_0\n"
        "    imul\n"
        "    iload 4\n"
        "    iadd\n"
        "    aload_2\n"
        "    fstorea\n"
        "    iloadc_1\n"
        "    iinc_1 4\n"
        "    jump _for11\n"
        "_endfor11:\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 5\n"
        "    iloadc_1\n"
        "    iinc_1 3\n"
        "    jump _for10\n"
        "_endfor10:\n"
        "    return\n"
        ".exportfun \"matMul\" bool int int int int int int float[] float[] float[] matMul\n"
        "matMul:\n"
        "    esr 10\n"
        "    iload 4\n"
        "    iload_3\n"
        "    ine\n"
        "    branch_f _pfalse2\n"
        "    bloadc_t\n"
        "    jump _pend2\n"
        "_pfalse2:\n"
        "    iload 5\n"
        "    iload_1\n"
        "    ine\n"
        "_pend2:\n"
        "    branch_f _pfalse1\n"
        "    bloadc_t\n"
        "    jump _pend1\n"
        "_pfalse1:\n"
        "    iload_2\n"
        "    iload_0\n"
        "    ine\n"
        "_pend1:\n"
        "    branch_f _ifend0\n"
        "    bloadc_f\n"
        "    breturn\n"
        "_ifend0:\n"
        "    iload 5\n"
        "    istore 14\n"
        "    iloadc_0\n"
        "    istore 9\n"
        "_for12:\n"
        "    iload 9\n"
        "    iload 14\n"
        "    ilt\n"
        "    branch_f _endfor12\n"
        "    iload_2\n"
        "    istore 15\n"
        "    iloadc_0\n"
        "    istore 10\n"
        "_for13:\n"
        "    iload 10\n"
        "    iload 15\n"
        "    ilt\n"
        "    branch_f _endfor13\n"
        "    floadc_0\n"
        "    iload 9\n"
        "    iload_0\n"
        "    imul\n"
        "    iload 10\n"
        "    iadd\n"
        "    aload 8\n"
        "    fstorea\n"
        "    iloadc_1\n"
        "    iinc_1 10\n"
        "    jump _for13\n"
        "_endfor13:\n"
        "    iloadc_1\n"
        "    iinc_1 9\n"
        "    jump _for12\n"
        "_endfor12:\n"
        "    iload 5\n"
        "    istore 16\n"
        "    iloadc_0\n"
        "    istore 11\n"
        "_for14:\n"
        "    iload 11\n"
        "    iload 16\n"
        "    ilt\n"
        "    branch_f _endfor14\n"
        "    iload 4\n"
        "    istore 17\n"
        "    iloadc_0\n"
        "    istore 12\n"
        "_for15:\n"
        "    iload 12\n"
        "    iload 17\n"
        "    ilt\n"
        "    branch_f _endfor15\n"
        "    iload_2\n"
        "    istore 18\n"
        "    iloadc_0\n"
        "    istore 13\n"
        "_for16:\n"
        "    iload 13\n"
        "    iload 18\n"
        "    ilt\n"
        "    branch_f _endfor16\n"
        "    iload 11\n"
        "    iload_0\n"
        "    imul\n"
        "    iload 13\n"
        "    iadd\n"
        "    aload 8\n"
        "    floada\n"
        "    iload 11\n"
        "    iload 4\n"
        "    imul\n"
        "    iload 12\n"
        "    iadd\n"
        "    aload 6\n"
        "    floada\n"
        "    iload 12\n"
        "    iload_2\n"
        "    imul\n"
        "    iload 13\n"
        "    iadd\n"
        "    aload 7\n"
        "    floada\n"
        "    fmul\n"
        "    fadd\n"
        "    iload 11\n"
        "    iload_0\n"
        "    imul\n"
        "    iload 13\n"
        "    iadd\n"
        "    aload 8\n"
        "    fstorea\n"
        "    iloadc_1\n"
        "    iinc_1 13\n"
        "    jump _for16\n"
        "_endfor16:\n"
        "    iloadc_1\n"
        "    iinc_1 12\n"
        "    jump _for15\n"
        "_endfor15:\n"
        "    iloadc_1\n"
        "    iinc_1 11\n"
        "    jump _for14\n"
        "_endfor14:\n"
        "    bloadc_t\n"
        "    breturn\n"
        ".exportfun \"queens\" bool int int bool[] queens\n"
        "queens:\n"
        "    esr 16\n"
        "    iload_1\n"
        "    istore 3\n"
        "    iload_3\n"
        "    inewa\n"
        "    astore 6\n"
        "    iloadc_1\n"
        "    ineg\n"
        "    istore 4\n"
        "    iloadc_0\n"
        "    istore 5\n"
        "_for17:\n"
        "    iload 5\n"
        "    iload_3\n"
        "    ilt\n"
        "    branch_f _endfor17\n"
        "    iload 4\n"
        "    iload 5\n"
        "    aload 6\n"
        "    istorea\n"
        "    iinc_1 5\n"
        "    jump _for17\n"
        "_endfor17:\n"
        "    iload_1\n"
        "    istore 7\n"
        "    iload 7\n"
        "    inewa\n"
        "    astore 10\n"
        "    iload_1\n"
        "    iload_0\n"
        "    iadd\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    istore 8\n"
        "    iloadc_0\n"
        "    istore 9\n"
        "_for18:\n"
        "    iload 9\n"
        "    iload 7\n"
        "    ilt\n"
        "    branch_f _endfor18\n"
        "    iload 8\n"
        "    iload 9\n"
        "    aload 10\n"
        "    istorea\n"
        "    iinc_1 9\n"
        "    jump _for18\n"
        "_endfor18:\n"
        "    iload_1\n"
        "    istore 11\n"
        "    iload 11\n"
        "    inewa\n"
        "    astore 14\n"
        "    iload_1\n"
        "    ineg\n"
        "    iload_0\n"
        "    isub\n"
        "    istore 12\n"
        "    iloadc_0\n"
        "    istore 13\n"
        "_for19:\n"
        "    iload 13\n"
        "    iload 11\n"
        "    ilt\n"
        "    branch_f _endfor19\n"
        "    iload 12\n"
        "    iload 13\n"
        "    aload 14\n"
        "    istorea\n"
        "    iinc_1 13\n"
        "    jump _for19\n"
        "_endfor19:\n"
        "    iloadc_0\n"
        "    istore 15\n"
        "    isrl\n"
        "    jsr 0 lf1_isValid\n"
        "    bnot\n"
        "    branch_f _ifend3\n"
        "    bloadc_f\n"
        "    breturn\n"
        "_ifend3:\n"
        "    isrl\n"
        "    iload 15\n"
        "    jsr 1 lf2_solveQueens\n"
        "    branch_f _ifend4\n"
        "    iload_1\n"
        "    istore 17\n"
        "    iloadc_0\n"
        "    istore 16\n"
        "_for20:\n"
        "    iload 16\n"
        "    iload 17\n"
        "    ilt\n"
        "    branch_f _endfor20\n"
        "    iload 16\n"
        "    aload 6\n"
        "    iloada\n"
        "    istore 18\n"
        "    bloadc_t\n"
        "    iload 16\n"
        "    iload_0\n"
        "    imul\n"
        "    iload 18\n"
        "    iadd\n"
        "    aload_2\n"
        "    bstorea\n"
        "    iloadc_1\n"
        "    iinc_1 16\n"
        "    jump _for20\n"
        "_endfor20:\n"
        "    bloadc_t\n"
        "    breturn\n"
        "_ifend4:\n"
        "    bloadc_f\n"
        "    breturn\n"
        "lf0_contains:\n"
        "    esr 2\n"
        "    iload_0\n"
        "    istore 4\n"
        "    iloadc_0\n"
        "    istore 3\n"
        "_for21:\n"
        "    iload_3\n"
        "    iload 4\n"
        "    ilt\n"
        "    branch_f _endfor21\n"
        "    iload_3\n"
        "    aload_1\n"
        "    iloada\n"
        "    iload_2\n"
        "    ieq\n"
        "    branch_f _ifend5\n"
        "    bloadc_t\n"
        "    breturn\n"
        "_ifend5:\n"
        "    iloadc_1\n"
        "    iinc_1 3\n"
        "    jump _for21\n"
        "_endfor21:\n"
        "    bloadc_f\n"
        "    breturn\n"
        "lf1_isValid:\n"
        "    esr 4\n"
        "    iloadn 1 1\n"
        "    iloadn 1 0\n"
        "    ine\n"
        "    branch_f _ifend6\n"
        "    bloadc_f\n"
        "    breturn\n"
        "_ifend6:\n"
        "    iloadn 1 1\n"
        "    istore 2\n"
        "    iloadc_0\n"
        "    istore 0\n"
        "_for22:\n"
        "    iload_0\n"
        "    iload_2\n"
        "    ilt\n"
        "    branch_f _endfor22\n"
        "    iloadn 1 0\n"
        "    istore 3\n"
        "    iloadc_0\n"
        "    istore 1\n"
        "_for23:\n"
        "    iload_1\n"
        "    iload_3\n"
        "    ilt\n"
        "    branch_f _endfor23\n"
        "    iload_0\n"
        "    iloadn 1 0\n"
        "    imul\n"
        "    iload_1\n"
        "    iadd\n"
        "    aloadn 1 2\n"
        "    bloada\n"
        "    branch_f _ifend7\n"
        "    iload_0\n"
        "    aloadn 1 6\n"
        "    iloada\n"
        "    iloadc_1\n"
        "    ineg\n"
        "    ine\n"
        "    branch_f _pfalse11\n"
        "    bloadc_t\n"
        "    jump _pend11\n"
        "_pfalse11:\n"
        "    isr\n"
        "    iloadn 1 1\n"
        "    aloadn 1 6\n"
        "    iload_1\n"
        "    jsr 3 lf0_contains\n"
        "_pend11:\n"
        "    branch_f _pfalse10\n"
        "    bloadc_t\n"
        "    jump _pend10\n"
        "_pfalse10:\n"
        "    isr\n"
        "    iloadn 1 1\n"
        "    aloadn 1 10\n"
        "    iload_0\n"
        "    iload_1\n"
        "    iadd\n"
        "    jsr 3 lf0_contains\n"
        "_pend10:\n"
        "    branch_f _pfalse9\n"
        "    bloadc_t\n"
        "    jump _pend9\n"
        "_pfalse9:\n"
        "    isr\n"
        "    iloadn 1 1\n"
        "    aloadn 1 14\n"
        "    iload_0\n"
        "    iload_1\n"
        "    isub\n"
        "    jsr 3 lf0_contains\n"
        "_pend9:\n"
        "    branch_f _ifend8\n"
        "    bloadc_f\n"
        "    breturn\n"
        "_ifend8:\n"
        "    iload_1\n"
        "    iload_0\n"
        "    aloadn 1 6\n"
        "    istorea\n"
        "    iload_0\n"
        "    iload_1\n"
        "    iadd\n"
        "    iload_0\n"
        "    aloadn 1 10\n"
        "    istorea\n"
        "    iload_0\n"
        "    iload_1\n"
        "    isub\n"
        "    iload_0\n"
        "    aloadn 1 14\n"
        "    istorea\n"
        "    iload_0\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    istoren 1 15\n"
        "_ifend7:\n"
        "    iloadc_1\n"
        "    iinc_1 1\n"
        "    jump _for23\n"
        "_endfor23:\n"
        "    iloadc_1\n"
        "    iinc_1 0\n"
        "    jump _for22\n"
        "_endfor22:\n"
        "    bloadc_t\n"
        "    breturn\n"
        "lf2_solveQueens:\n"
        "    esr 2\n"
        "    iload_0\n"
        "    iloadn 1 1\n"
        "    ilt\n"
        "    branch_f _ifend12\n"
        "    iloadn 1 0\n"
        "    istore 2\n"
        "    iloadc_0\n"
        "    istore 1\n"
        "_for24:\n"
        "    iload_1\n"
        "    iload_2\n"
        "    ilt\n"
        "    branch_f _endfor24\n"
        "    isr\n"
        "    iloadn 1 1\n"
        "    aloadn 1 6\n"
        "    iload_1\n"
        "    jsr 3 lf0_contains\n"
        "    bnot\n"
        "    branch_f _pfalse15\n"
        "    isr\n"
        "    iloadn 1 1\n"
        "    aloadn 1 10\n"
        "    iload_0\n"
        "    iload_1\n"
        "    iadd\n"
        "    jsr 3 lf0_contains\n"
        "    bnot\n"
        "    jump _pend15\n"
        "_pfalse15:\n"
        "    bloadc_f\n"
        "_pend15:\n"
        "    branch_f _pfalse14\n"
        "    isr\n"
        "    iloadn 1 1\n"
        "    aloadn 1 14\n"
        "    iload_0\n"
        "    iload_1\n"
        "    isub\n"
        "    jsr 3 lf0_contains\n"
        "    bnot\n"
        "    jump _pend14\n"
        "_pfalse14:\n"
        "    bloadc_f\n"
        "_pend14:\n"
        "    branch_f _ifend13\n"
        "    iload_1\n"
        "    iload_0\n"
        "    aloadn 1 6\n"
        "    istorea\n"
        "    iload_0\n"
        "    iload_1\n"
        "    iadd\n"
        "    iload_0\n"
        "    aloadn 1 10\n"
        "    istorea\n"
        "    iload_0\n"
        "    iload_1\n"
        "    isub\n"
        "    iload_0\n"
        "    aloadn 1 14\n"
        "    istorea\n"
        "    isr\n"
        "    iload_0\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    jsr 1 lf2_solveQueens\n"
        "    bnot\n"
        "    branch_f _else16\n"
        "    iloadc_1\n"
        "    ineg\n"
        "    iload_0\n"
        "    aloadn 1 6\n"
        "    istorea\n"
        "    iloadn 1 1\n"
        "    iloadn 1 0\n"
        "    iadd\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    iload_0\n"
        "    aloadn 1 10\n"
        "    istorea\n"
        "    iloadn 1 1\n"
        "    ineg\n"
        "    iloadn 1 0\n"
        "    isub\n"
        "    iload_0\n"
        "    aloadn 1 14\n"
        "    istorea\n"
        "    jump _ifend16\n"
        "_else16:\n"
        "    bloadc_t\n"
        "    breturn\n"
        "_ifend16:\n"
        "_ifend13:\n"
        "    iloadc_1\n"
        "    iinc_1 1\n"
        "    jump _for24\n"
        "_endfor24:\n"
        "    bloadc_f\n"
        "    breturn\n"
        "_ifend12:\n"
        "    bloadc_t\n"
        "    breturn\n"
        ".exportfun \"__init\" void __init\n"
        "__init:\n"
        "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Functional_Assignment01_Core)
{
    SetUp("functional/assignment_01/core.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".exportfun \"gcd\" int int int gcd\n"
                           "gcd:\n"
                           "    esr 1\n"
                           "    iload_1\n"
                           "    iloadc_0\n"
                           "    ieq\n"
                           "    branch_f _pfalse1\n"
                           "    bloadc_t\n"
                           "    jump _pend1\n"
                           "_pfalse1:\n"
                           "    iload_0\n"
                           "    iloadc_0\n"
                           "    ieq\n"
                           "_pend1:\n"
                           "    branch_f _ifend0\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           "_ifend0:\n"
                           "    iload_0\n"
                           "    iload_1\n"
                           "    irem\n"
                           "    istore 2\n"
                           "_while0:\n"
                           "    iload_2\n"
                           "    iloadc_0\n"
                           "    ine\n"
                           "    branch_f _whileend0\n"
                           "    iload_1\n"
                           "    istore 0\n"
                           "    iload_2\n"
                           "    istore 1\n"
                           "    iload_0\n"
                           "    iload_1\n"
                           "    irem\n"
                           "    istore 2\n"
                           "    jump _while0\n"
                           "_whileend0:\n"
                           "    iload_1\n"
                           "    ireturn\n"
                           ".exportfun \"fac\" int int fac\n"
                           "fac:\n"
                           "    esr 5\n"
                           "    iloadc_1\n"
                           "    istore 1\n"
                           "    iload_0\n"
                           "    iloadc_0\n"
                           "    ieq\n"
                           "    branch_f _else2\n"
                           "    iloadc_1\n"
                           "    ireturn\n"
                           "    jump _ifend2\n"
                           "_else2:\n"
                           "    iload_0\n"
                           "    iloadc_0\n"
                           "    ilt\n"
                           "    branch_f _ifend3\n"
                           "    iload_0\n"
                           "    ireturn\n"
                           "_ifend3:\n"
                           "_ifend2:\n"
                           "    iload_0\n"
                           "    istore 3\n"
                           "    iloadc_0\n"
                           "    istore 4\n"
                           "    iloadc_1\n"
                           "    ineg\n"
                           "    istore 5\n"
                           "    iload_3\n"
                           "    istore 2\n"
                           "    iload 4\n"
                           "    iload_2\n"
                           "    isub\n"
                           "    iload 5\n"
                           "    idiv\n"
                           "    istore 4\n"
                           "    iload 4\n"
                           "    iload 5\n"
                           "    irem\n"
                           "    iloadc_0\n"
                           "    ieq\n"
                           "    branch_t _for1\n"
                           "    iinc_1 4\n"
                           "_for1:\n"
                           "    iload 4\n"
                           "    iloadc_0\n"
                           "    igt\n"
                           "    branch_f _endfor1\n"
                           "    iload_1\n"
                           "    iload_2\n"
                           "    imul\n"
                           "    istore 1\n"
                           "    idec_1 4\n"
                           "    iload_2\n"
                           "    iload 5\n"
                           "    iadd\n"
                           "    istore 2\n"
                           "    jump _for1\n"
                           "_endfor1:\n"
                           "    iload_1\n"
                           "    ireturn\n"
                           ".exportfun \"fib\" int int fib\n"
                           "fib:\n"
                           "    iload_0\n"
                           ".const int 0x3  ; 3\n"
                           "    iloadc 0\n"
                           "    ige\n"
                           "    branch_f _else4\n"
                           "    isrg\n"
                           "    iload_0\n"
                           "    iloadc_1\n"
                           "    isub\n"
                           "    jsr 1 fib\n"
                           "    isrg\n"
                           "    iload_0\n"
                           ".const int 0x2  ; 2\n"
                           "    iloadc 1\n"
                           "    isub\n"
                           "    jsr 1 fib\n"
                           "    iadd\n"
                           "    ireturn\n"
                           "    jump _ifend4\n"
                           "_else4:\n"
                           "    iload_0\n"
                           "    iloadc_0\n"
                           "    ile\n"
                           "    branch_f _ifend5\n"
                           "    iloadc_0\n"
                           "    ireturn\n"
                           "_ifend5:\n"
                           "_ifend4:\n"
                           "    iloadc_1\n"
                           "    ireturn\n"
                           ".exportfun \"isprime\" bool int isprime\n"
                           "isprime:\n"
                           "    esr 2\n"
                           "    iload_0\n"
                           "    iloadc_1\n"
                           "    ile\n"
                           "    branch_f _else6\n"
                           "    bloadc_f\n"
                           "    breturn\n"
                           "    jump _ifend6\n"
                           "_else6:\n"
                           "    iload_0\n"
                           "    iloadc 1\n"
                           "    ieq\n"
                           "    branch_f _pfalse10\n"
                           "    bloadc_t\n"
                           "    jump _pend10\n"
                           "_pfalse10:\n"
                           "    iload_0\n"
                           "    iloadc 0\n"
                           "    ieq\n"
                           "_pend10:\n"
                           "    branch_f _pfalse9\n"
                           "    bloadc_t\n"
                           "    jump _pend9\n"
                           "_pfalse9:\n"
                           "    iload_0\n"
                           ".const int 0x5  ; 5\n"
                           "    iloadc 2\n"
                           "    ieq\n"
                           "_pend9:\n"
                           "    branch_f _pfalse8\n"
                           "    bloadc_t\n"
                           "    jump _pend8\n"
                           "_pfalse8:\n"
                           "    iload_0\n"
                           ".const int 0x7  ; 7\n"
                           "    iloadc 3\n"
                           "    ieq\n"
                           "_pend8:\n"
                           "    branch_f _else7\n"
                           "    bloadc_t\n"
                           "    breturn\n"
                           "    jump _ifend7\n"
                           "_else7:\n"
                           "    iload_0\n"
                           "    iloadc 1\n"
                           "    irem\n"
                           "    iloadc_0\n"
                           "    ieq\n"
                           "    branch_f _pfalse14\n"
                           "    bloadc_t\n"
                           "    jump _pend14\n"
                           "_pfalse14:\n"
                           "    iload_0\n"
                           "    iloadc 0\n"
                           "    irem\n"
                           "    iloadc_0\n"
                           "    ieq\n"
                           "_pend14:\n"
                           "    branch_f _pfalse13\n"
                           "    bloadc_t\n"
                           "    jump _pend13\n"
                           "_pfalse13:\n"
                           "    iload_0\n"
                           "    iloadc 2\n"
                           "    irem\n"
                           "    iloadc_0\n"
                           "    ieq\n"
                           "_pend13:\n"
                           "    branch_f _pfalse12\n"
                           "    bloadc_t\n"
                           "    jump _pend12\n"
                           "_pfalse12:\n"
                           "    iload_0\n"
                           "    iloadc 3\n"
                           "    irem\n"
                           "    iloadc_0\n"
                           "    ieq\n"
                           "_pend12:\n"
                           "    branch_f _ifend11\n"
                           "    bloadc_f\n"
                           "    breturn\n"
                           "_ifend11:\n"
                           "_ifend7:\n"
                           "_ifend6:\n"
                           "    iload_0\n"
                           "    istore 2\n"
                           ".const int 0xb  ; 11\n"
                           "    iloadc 4\n"
                           "    istore 1\n"
                           "_for2:\n"
                           "    iload_1\n"
                           "    iload_2\n"
                           "    ilt\n"
                           "    branch_f _endfor2\n"
                           "    iload_0\n"
                           "    iload_1\n"
                           "    irem\n"
                           "    iloadc_0\n"
                           "    ieq\n"
                           "    branch_f _ifend15\n"
                           "    bloadc_f\n"
                           "    breturn\n"
                           "_ifend15:\n"
                           "    iloadc_1\n"
                           "    iinc_1 1\n"
                           "    jump _for2\n"
                           "_endfor2:\n"
                           "    bloadc_t\n"
                           "    breturn\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, Functional_Assignment01_Test)
{
    SetUp("functional/assignment_01/test.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected =
        ".importfun \"printInt\" void int\n"
        ".importfun \"printFloat\" void float\n"
        ".importfun \"scanInt\" int\n"
        ".importfun \"scanFloat\" float\n"
        ".importfun \"printSpaces\" void int\n"
        ".importfun \"printNewlines\" void int\n"
        ".importfun \"gcd\" int int int\n"
        ".importfun \"fac\" int int\n"
        ".importfun \"fib\" int int\n"
        ".importfun \"isprime\" bool int\n"
        ".importfun \"printIntVec\" void int int[]\n"
        ".importfun \"printFloatVec\" void int float[]\n"
        ".importfun \"printIntMat\" void int int int[]\n"
        ".importfun \"printFloatMat\" void int int float[]\n"
        ".importfun \"scanIntVec\" void int int[]\n"
        ".importfun \"scanFloatVec\" void int float[]\n"
        ".importfun \"scanIntMat\" void int int int[]\n"
        ".importfun \"scanFloatMat\" void int int float[]\n"
        ".importfun \"matMul\" bool int int int int int int float[] float[] float[]\n"
        ".importfun \"queens\" bool int int bool[]\n"
        ".global int\n"
        ".global int\n"
        ".global int\n"
        ".exportfun \"main\" int main\n"
        "main:\n"
        "    isrg\n"
        "    jsr 0 test_gcd\n"
        "    iloadc_0\n"
        "    istoreg 2\n"
        "    isrg\n"
        "    jsr 0 test_fac\n"
        "    iloadc_0\n"
        "    istoreg 2\n"
        "    isrg\n"
        "    jsr 0 test_fib\n"
        "    iloadc_0\n"
        "    istoreg 2\n"
        "    isrg\n"
        "    jsr 0 test_isprime\n"
        "    iloadc_0\n"
        "    istoreg 2\n"
        "    isrg\n"
        "    jsr 0 test_matMul\n"
        "    isrg\n"
        "    iloadg 0\n"
        "    jsre 0\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 4\n"
        "    isrg\n"
        "    iloadg 1\n"
        "    jsre 0\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 5\n"
        "    iloadc_0\n"
        "    ireturn\n"
        "test:\n"
        "    esr 1\n"
        "    iload_0\n"
        "    iload_1\n"
        "    ieq\n"
        "    bstore 2\n"
        "    iloadg 1\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    istoreg 1\n"
        "    iloadg 2\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    istoreg 2\n"
        "    iloadg 0\n"
        "    bload_2\n"
        "    branch_f _pfalse0\n"
        "    iloadc_1\n"
        "    jump _pend0\n"
        "_pfalse0:\n"
        "    iloadc_0\n"
        "_pend0:\n"
        "    iadd\n"
        "    istoreg 0\n"
        "    bload_2\n"
        "    bnot\n"
        "    branch_f _ifend1\n"
        "    isrg\n"
        "    iloadg 2\n"
        "    jsre 0\n"
        "    isrg\n"
        ".const int 0x4  ; 4\n"
        "    iloadc 0\n"
        "    jsre 4\n"
        "    isrg\n"
        "    iload_0\n"
        "    jsre 0\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 4\n"
        "    isrg\n"
        "    iload_1\n"
        "    jsre 0\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 5\n"
        "_ifend1:\n"
        "    return\n"
        "testB:\n"
        "    isrg\n"
        "    bload_0\n"
        "    branch_f _pfalse2\n"
        "    iloadc_1\n"
        "    jump _pend2\n"
        "_pfalse2:\n"
        "    iloadc_0\n"
        "_pend2:\n"
        "    bload_1\n"
        "    branch_f _pfalse3\n"
        "    iloadc_1\n"
        "    jump _pend3\n"
        "_pfalse3:\n"
        "    iloadc_0\n"
        "_pend3:\n"
        "    jsr 2 test\n"
        "    return\n"
        "testFMat:\n"
        "    esr 7\n"
        "    iload_1\n"
        "    iload_0\n"
        "    imul\n"
        "    istore 9\n"
        "    iload 9\n"
        "    fnewa\n"
        "    astore 12\n"
        "    floadc_1\n"
        "    fneg\n"
        "    fstore 10\n"
        "    iloadc_0\n"
        "    istore 11\n"
        "_for0:\n"
        "    iload 11\n"
        "    iload 9\n"
        "    ilt\n"
        "    branch_f _endfor0\n"
        "    fload 10\n"
        "    iload 11\n"
        "    aload 12\n"
        "    fstorea\n"
        "    iinc_1 11\n"
        "    jump _for0\n"
        "_endfor0:\n"
        "    bloadc_t\n"
        "    bstore 13\n"
        "    isrg\n"
        "    iload_0\n"
        "    iload_1\n"
        "    iload_2\n"
        "    iload_3\n"
        "    iload 4\n"
        "    iload 5\n"
        "    aload 6\n"
        "    aload 7\n"
        "    aload 12\n"
        "    jsre 18\n"
        "    bpop\n"
        "    iloadc_0\n"
        "    istore 14\n"
        "_for1:\n"
        "    iload 14\n"
        ".const int 0x3  ; 3\n"
        "    iloadc 1\n"
        "    ilt\n"
        "    branch_f _endfor1\n"
        "    iloadc_0\n"
        "    istore 15\n"
        "_for2:\n"
        "    iload 15\n"
        ".const int 0x5  ; 5\n"
        "    iloadc 2\n"
        "    ilt\n"
        "    branch_f _endfor2\n"
        "    iload 14\n"
        "    iload_0\n"
        "    imul\n"
        "    iload 15\n"
        "    iadd\n"
        "    aload 12\n"
        "    floada\n"
        "    iload 14\n"
        "    iload_0\n"
        "    imul\n"
        "    iload 15\n"
        "    iadd\n"
        "    aload 8\n"
        "    floada\n"
        "    fne\n"
        "    branch_f _ifend4\n"
        "    bloadc_f\n"
        "    bstore 13\n"
        "    isrg\n"
        "    iload 14\n"
        "    jsre 0\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 4\n"
        "    isrg\n"
        "    iload 15\n"
        "    jsre 0\n"
        "    isrg\n"
        "    iloadc 1\n"
        "    jsre 4\n"
        "    isrg\n"
        "    iload 14\n"
        "    iload_0\n"
        "    imul\n"
        "    iload 15\n"
        "    iadd\n"
        "    aload 8\n"
        "    floada\n"
        "    jsre 1\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 4\n"
        "    isrg\n"
        "    iload 14\n"
        "    iload_0\n"
        "    imul\n"
        "    iload 15\n"
        "    iadd\n"
        "    aload 12\n"
        "    floada\n"
        "    jsre 1\n"
        "    isrg\n"
        ".const int 0x2  ; 2\n"
        "    iloadc 3\n"
        "    jsre 5\n"
        "_ifend4:\n"
        "    iloadc_1\n"
        "    iinc_1 15\n"
        "    jump _for2\n"
        "_endfor2:\n"
        "    iloadc_1\n"
        "    iinc_1 14\n"
        "    jump _for1\n"
        "_endfor1:\n"
        "    iloadg 1\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    istoreg 1\n"
        "    iloadg 2\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    istoreg 2\n"
        "    iloadg 0\n"
        "    bload 13\n"
        "    branch_f _pfalse5\n"
        "    iloadc_1\n"
        "    jump _pend5\n"
        "_pfalse5:\n"
        "    iloadc_0\n"
        "_pend5:\n"
        "    iadd\n"
        "    istoreg 0\n"
        "    return\n"
        "test_gcd:\n"
        "    isrg\n"
        ".const int 0x6  ; 6\n"
        "    iloadc 4\n"
        "    isrg\n"
        ".const int 0xc  ; 12\n"
        "    iloadc 5\n"
        ".const int 0x12  ; 18\n"
        "    iloadc 6\n"
        "    jsre 6\n"
        "    jsr 2 test\n"
        "    isrg\n"
        "    iloadc 4\n"
        "    isrg\n"
        "    iloadc 6\n"
        "    iloadc 5\n"
        "    jsre 6\n"
        "    jsr 2 test\n"
        "    isrg\n"
        ".const int 0x26  ; 38\n"
        "    iloadc 7\n"
        "    isrg\n"
        "    iloadc 7\n"
        "    iloadc 7\n"
        "    jsre 6\n"
        "    jsr 2 test\n"
        "    isrg\n"
        "    iloadc_0\n"
        "    isrg\n"
        "    iloadc 5\n"
        "    iloadc_0\n"
        "    jsre 6\n"
        "    jsr 2 test\n"
        "    isrg\n"
        "    iloadc_0\n"
        "    isrg\n"
        "    iloadc_0\n"
        "    iloadc 2\n"
        "    jsre 6\n"
        "    jsr 2 test\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    isrg\n"
        ".const int 0x22  ; 34\n"
        "    iloadc 8\n"
        "    iloadc_1\n"
        "    jsre 6\n"
        "    jsr 2 test\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    isrg\n"
        "    iloadc_1\n"
        ".const int 0x2b  ; 43\n"
        "    iloadc 9\n"
        "    jsre 6\n"
        "    jsr 2 test\n"
        "    return\n"
        "test_fac:\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    ineg\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    ineg\n"
        "    jsre 7\n"
        "    jsr 2 test\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    isrg\n"
        "    iloadc_0\n"
        "    jsre 7\n"
        "    jsr 2 test\n"
        "    isrg\n"
        ".const int 0x78  ; 120\n"
        "    iloadc 10\n"
        "    isrg\n"
        "    iloadc 2\n"
        "    jsre 7\n"
        "    jsr 2 test\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 7\n"
        "    jsr 2 test\n"
        "    return\n"
        "test_fib:\n"
        "    isrg\n"
        ".const int 0x37  ; 55\n"
        "    iloadc 11\n"
        "    isrg\n"
        ".const int 0xa  ; 10\n"
        "    iloadc 12\n"
        "    jsre 8\n"
        "    jsr 2 test\n"
        "    isrg\n"
        "    iloadc_0\n"
        "    isrg\n"
        "    iloadc_0\n"
        "    jsre 8\n"
        "    jsr 2 test\n"
        "    isrg\n"
        "    iloadc_0\n"
        "    isrg\n"
        "    iloadc 5\n"
        "    ineg\n"
        "    jsre 8\n"
        "    jsr 2 test\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 8\n"
        "    jsr 2 test\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    isrg\n"
        "    iloadc 3\n"
        "    jsre 8\n"
        "    jsr 2 test\n"
        "    return\n"
        "test_isprime:\n"
        "    isrg\n"
        "    bloadc_f\n"
        "    isrg\n"
        "    iloadc 5\n"
        "    ineg\n"
        "    jsre 9\n"
        "    jsr 2 testB\n"
        "    isrg\n"
        "    bloadc_f\n"
        "    isrg\n"
        "    iloadc_0\n"
        "    jsre 9\n"
        "    jsr 2 testB\n"
        "    isrg\n"
        "    bloadc_f\n"
        "    isrg\n"
        "    iloadc_1\n"
        "    jsre 9\n"
        "    jsr 2 testB\n"
        "    isrg\n"
        "    bloadc_t\n"
        "    isrg\n"
        "    iloadc 3\n"
        "    jsre 9\n"
        "    jsr 2 testB\n"
        "    isrg\n"
        "    bloadc_t\n"
        "    isrg\n"
        ".const int 0xd  ; 13\n"
        "    iloadc 13\n"
        "    jsre 9\n"
        "    jsr 2 testB\n"
        "    isrg\n"
        "    bloadc_f\n"
        "    isrg\n"
        ".const int 0x19  ; 25\n"
        "    iloadc 14\n"
        "    jsre 9\n"
        "    jsr 2 testB\n"
        "    isrg\n"
        "    bloadc_t\n"
        "    isrg\n"
        ".const int 0x61  ; 97\n"
        "    iloadc 15\n"
        "    jsre 9\n"
        "    jsr 2 testB\n"
        "    isrg\n"
        "    bloadc_f\n"
        "    isrg\n"
        ".const int 0x79  ; 121\n"
        "    iloadc 16\n"
        "    jsre 9\n"
        "    jsr 2 testB\n"
        "    return\n"
        "test_matMul:\n"
        "    esr 6\n"
        "    iloadc 1\n"
        "    iloadc 3\n"
        "    imul\n"
        "    istore 0\n"
        "    iload_0\n"
        "    fnewa\n"
        "    astore 1\n"
        "    floadc_1\n"
        "    iloadc_0\n"
        "    iloadc 3\n"
        "    imul\n"
        "    iloadc_0\n"
        "    iadd\n"
        "    aload_1\n"
        "    fstorea\n"
        ".const float 0x1p+1  ; 2.000000e+00\n"
        "    floadc 17\n"
        "    iloadc_0\n"
        "    iloadc 3\n"
        "    imul\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    aload_1\n"
        "    fstorea\n"
        ".const float 0x1.8p+1  ; 3.000000e+00\n"
        "    floadc 18\n"
        "    iloadc_1\n"
        "    iloadc 3\n"
        "    imul\n"
        "    iloadc_0\n"
        "    iadd\n"
        "    aload_1\n"
        "    fstorea\n"
        ".const float 0x1p+2  ; 4.000000e+00\n"
        "    floadc 19\n"
        "    iloadc_1\n"
        "    iloadc 3\n"
        "    imul\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    aload_1\n"
        "    fstorea\n"
        ".const float 0x1.4p+2  ; 5.000000e+00\n"
        "    floadc 20\n"
        "    iloadc 3\n"
        "    iloadc 3\n"
        "    imul\n"
        "    iloadc_0\n"
        "    iadd\n"
        "    aload_1\n"
        "    fstorea\n"
        ".const float 0x1.8p+2  ; 6.000000e+00\n"
        "    floadc 21\n"
        "    iloadc 3\n"
        "    iloadc 3\n"
        "    imul\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    aload_1\n"
        "    fstorea\n"
        "    iloadc 3\n"
        "    iloadc 2\n"
        "    imul\n"
        "    istore 2\n"
        "    iload_2\n"
        "    fnewa\n"
        "    astore 3\n"
        "    floadc_1\n"
        "    iloadc_0\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc_0\n"
        "    iadd\n"
        "    aload_3\n"
        "    fstorea\n"
        "    floadc 17\n"
        "    iloadc_0\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    aload_3\n"
        "    fstorea\n"
        "    floadc 18\n"
        "    iloadc_0\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 3\n"
        "    iadd\n"
        "    aload_3\n"
        "    fstorea\n"
        "    floadc 19\n"
        "    iloadc_0\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 1\n"
        "    iadd\n"
        "    aload_3\n"
        "    fstorea\n"
        "    floadc 20\n"
        "    iloadc_0\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 0\n"
        "    iadd\n"
        "    aload_3\n"
        "    fstorea\n"
        "    floadc 21\n"
        "    iloadc_1\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc_0\n"
        "    iadd\n"
        "    aload_3\n"
        "    fstorea\n"
        ".const float 0x1.cp+2  ; 7.000000e+00\n"
        "    floadc 22\n"
        "    iloadc_1\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    aload_3\n"
        "    fstorea\n"
        ".const float 0x1p+3  ; 8.000000e+00\n"
        "    floadc 23\n"
        "    iloadc_1\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 3\n"
        "    iadd\n"
        "    aload_3\n"
        "    fstorea\n"
        ".const float 0x1.2p+3  ; 9.000000e+00\n"
        "    floadc 24\n"
        "    iloadc_1\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 1\n"
        "    iadd\n"
        "    aload_3\n"
        "    fstorea\n"
        ".const float 0x1.4p+3  ; 1.000000e+01\n"
        "    floadc 25\n"
        "    iloadc_1\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 0\n"
        "    iadd\n"
        "    aload_3\n"
        "    fstorea\n"
        "    iloadc 1\n"
        "    iloadc 2\n"
        "    imul\n"
        "    istore 4\n"
        "    iload 4\n"
        "    fnewa\n"
        "    astore 5\n"
        ".const float 0x1.ap+3  ; 1.300000e+01\n"
        "    floadc 26\n"
        "    iloadc_0\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc_0\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        ".const float 0x1p+4  ; 1.600000e+01\n"
        "    floadc 27\n"
        "    iloadc_0\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        ".const float 0x1.3p+4  ; 1.900000e+01\n"
        "    floadc 28\n"
        "    iloadc_0\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 3\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        ".const float 0x1.6p+4  ; 2.200000e+01\n"
        "    floadc 29\n"
        "    iloadc_0\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 1\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        ".const float 0x1.9p+4  ; 2.500000e+01\n"
        "    floadc 30\n"
        "    iloadc_0\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 0\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        ".const float 0x1.bp+4  ; 2.700000e+01\n"
        "    floadc 31\n"
        "    iloadc_1\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc_0\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        ".const float 0x1.1p+5  ; 3.400000e+01\n"
        "    floadc 32\n"
        "    iloadc_1\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        ".const float 0x1.48p+5  ; 4.100000e+01\n"
        "    floadc 33\n"
        "    iloadc_1\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 3\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        ".const float 0x1.8p+5  ; 4.800000e+01\n"
        "    floadc 34\n"
        "    iloadc_1\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 1\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        ".const float 0x1.b8p+5  ; 5.500000e+01\n"
        "    floadc 35\n"
        "    iloadc_1\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 0\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        "    floadc 33\n"
        "    iloadc 3\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc_0\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        ".const float 0x1.ap+5  ; 5.200000e+01\n"
        "    floadc 36\n"
        "    iloadc 3\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc_1\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        ".const float 0x1.f8p+5  ; 6.300000e+01\n"
        "    floadc 37\n"
        "    iloadc 3\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 3\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        ".const float 0x1.28p+6  ; 7.400000e+01\n"
        "    floadc 38\n"
        "    iloadc 3\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 1\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        ".const float 0x1.54p+6  ; 8.500000e+01\n"
        "    floadc 39\n"
        "    iloadc 3\n"
        "    iloadc 2\n"
        "    imul\n"
        "    iloadc 0\n"
        "    iadd\n"
        "    aload 5\n"
        "    fstorea\n"
        "    isrg\n"
        "    iloadc 2\n"
        "    iloadc 1\n"
        "    iloadc 2\n"
        "    iloadc 3\n"
        "    iloadc 3\n"
        "    iloadc 1\n"
        "    aload_1\n"
        "    aload_3\n"
        "    aload 5\n"
        "    jsr 9 testFMat\n"
        "    return\n"
        ".exportfun \"__init\" void __init\n"
        "__init:\n"
        "    iloadc_0\n"
        "    istoreg 0\n"
        "    iloadc_0\n"
        "    istoreg 1\n"
        "    iloadc_0\n"
        "    istoreg 2\n"
        "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, EdgeCasesValid)
{
    SetUp("codegen/edgecases/valid.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".importvar \"m\" int\n"
                           ".importvar \"s\" bool\n"
                           ".importvar \"__dim0_t\" int\n"
                           ".importvar \"t\" int[]\n"
                           "s:\n"
                           "    return\n"
                           "    istoree 2\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, PreperationEdgeCasesValid)
{
    SetUp("preperation/edgecase/valid.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".importvar \"m\" float\n"
                           ".global int\n"
                           ".exportvar \"nine\" 0\n"
                           ".importvar \"e\" float\n"
                           ".importvar \"t\" int\n"
                           ".global bool\n"
                           ".global int\n"
                           ".global float[]\n"
                           ".exportvar \"__dim0_p\" 2\n"
                           ".exportvar \"p\" 3\n"
                           ".global int\n"
                           ".global int[]\n"
                           ".exportvar \"__dim0_f\" 4\n"
                           ".exportvar \"f\" 5\n"
                           ".importvar \"c\" float\n"
                           ".global int\n"
                           ".global int\n"
                           ".exportfun \"e\" void e\n"
                           "e:\n"
                           "    esr 5\n"
                           "    iloadg 0\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    bnewa\n"
                           "    astore 3\n"
                           "    bloadg 1\n"
                           "    bstore 1\n"
                           "    iloadc_0\n"
                           "    istore 2\n"
                           "_for0:\n"
                           "    iload_2\n"
                           "    iload_0\n"
                           "    ilt\n"
                           "    branch_f _endfor0\n"
                           "    bload_1\n"
                           "    iload_2\n"
                           "    aload_3\n"
                           "    bstorea\n"
                           "    iinc_1 2\n"
                           "    jump _for0\n"
                           "_endfor0:\n"
                           "    iloadc_0\n"
                           "    aload_3\n"
                           "    bloada\n"
                           "    bstore 4\n"
                           "    return\n"
                           "m:\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    esr 6\n"
                           "    floade 1\n"
                           "    floadc_0\n"
                           "    fne\n"
                           "    branch_f _pfalse0\n"
                           "    bloadc_t\n"
                           "    jump _pend0\n"
                           "_pfalse0:\n"
                           "    bloadc_f\n"
                           "_pend0:\n"
                           "    bstoreg 1\n"
                           "    iloadc_0\n"
                           "    istoreg 2\n"
                           "    iloadg 2\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    fnewa\n"
                           "    astoreg 3\n"
                           "    floadc_0\n"
                           "    fstore 1\n"
                           "    iloadc_0\n"
                           "    istore 2\n"
                           "_for1:\n"
                           "    iload_2\n"
                           "    iload_0\n"
                           "    ilt\n"
                           "    branch_f _endfor1\n"
                           "    fload_1\n"
                           "    iload_2\n"
                           "    aloadg 3\n"
                           "    fstorea\n"
                           "    iinc_1 2\n"
                           "    jump _for1\n"
                           "_endfor1:\n"
                           "    iloadc_0\n"
                           "    istoreg 4\n"
                           "    iloadg 4\n"
                           "    istore 3\n"
                           "    iload_3\n"
                           "    inewa\n"
                           "    astoreg 5\n"
                           "    iloadc_0\n"
                           "    istore 4\n"
                           "    iloadc_0\n"
                           "    istore 5\n"
                           "_for2:\n"
                           "    iload 5\n"
                           "    iload_3\n"
                           "    ilt\n"
                           "    branch_f _endfor2\n"
                           "    iload 4\n"
                           "    iload 5\n"
                           "    aloadg 5\n"
                           "    istorea\n"
                           "    iinc_1 5\n"
                           "    jump _for2\n"
                           "_endfor2:\n"
                           "    iloadc_0\n"
                           "    istoreg 6\n"
                           "    iloadg 6\n"
                           "    istoreg 7\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}

TEST_F(GenerationTest, EdgeCasesValid2)
{
    SetUp("codegen/edgecases/valid2.cvc");
    ASSERT_NE(nullptr, root);

    const char *expected = ".importfun \"exIntFun\" int int int int int int bool[]\n"
                           ".importfun \"printInt\" void int\n"
                           "test:\n"
                           "    esr 4\n"
                           ".const int 0x7a  ; 122\n"
                           "    iloadc 0\n"
                           ".const int 0x17  ; 23\n"
                           "    iloadc 1\n"
                           "    imul\n"
                           ".const int 0x7b  ; 123\n"
                           "    iloadc 2\n"
                           "    imul\n"
                           "    iloadc_1\n"
                           "    imul\n"
                           "    istore 0\n"
                           "    iload_0\n"
                           "    bnewa\n"
                           "    astore 3\n"
                           "    bloadc_t\n"
                           "    bstore 1\n"
                           "    iloadc_0\n"
                           "    istore 2\n"
                           "_for0:\n"
                           "    iload_2\n"
                           "    iload_0\n"
                           "    ilt\n"
                           "    branch_f _endfor0\n"
                           "    bload_1\n"
                           "    iload_2\n"
                           "    aload_3\n"
                           "    bstorea\n"
                           "    iinc_1 2\n"
                           "    jump _for0\n"
                           "_endfor0:\n"
                           "    isrg\n"
                           "    isrg\n"
                           "    iloadc_1\n"
                           "    iloadc 2\n"
                           "    iloadc 1\n"
                           "    iloadc 0\n"
                           ".const int 0x15c95  ; 89237\n"
                           "    iloadc 3\n"
                           "    iloadc_1\n"
                           "    iadd\n"
                           "    aload_3\n"
                           "    jsre 0\n"
                           "    jsre 1\n"
                           "    return\n"
                           ".exportfun \"__init\" void __init\n"
                           "__init:\n"
                           "    return\n";

    ASSERT_MLSTREQ(expected, output_buffer);
}
